<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="dcterms.date" content="2025-09-22">
<title>7 A Model Workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../Books/Tidy Modeling with R/8 Feature Engineering with recipes.html" rel="next">
<link href="../../Books/Tidy Modeling with R/6 Fitting Models with parsnip.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-2bc269ba33bfe0c9779ec90686b7c52e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "Search",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">RSSPtho</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link active" href="../../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-books" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Books</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-books">
<li>
    <a class="dropdown-item" href="../../Books/ggplot2/index.html">
 <span class="dropdown-text">ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/R4DS2/index.html">
 <span class="dropdown-text">R for Data Science(2e)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/Tidy Modeling with R/index.html">
 <span class="dropdown-text">Tidy Modeling with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/Advanced R(2e)/index.html">
 <span class="dropdown-text">Advanced R(2e)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/quarto/Project Basics.html">
 <span class="dropdown-text">Quarto</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/Js4R/00 Preface.qmd">
 <span class="dropdown-text">Js4R</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About me</span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
    <a href="https://github.com/hanguojun007/Blog" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Books/Tidy Modeling with R/7 A Model Workflow.html">7 A Model Workflow</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello World</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">Introduction</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/1 Software for modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 Software for modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/2 A Tidyverse Primer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 A Tidyverse Primer</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/3 A Review of R Modeling Fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 A Review of R Modeling Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">Moduling Basics</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/4 The Ames Housing Data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 The Ames Housing Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/5 Spending our Data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5 Spending our Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/6 Fitting Models with parsnip.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6 Fitting Models with parsnip</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/7 A Model Workflow.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">7 A Model Workflow</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Tidy Modeling with R/8 Feature Engineering with recipes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8 Feature Engineering with recipes</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#where-does-the-model-begin-and-end" id="toc-where-does-the-model-begin-and-end" class="nav-link active" data-scroll-target="#where-does-the-model-begin-and-end">Where Does the Model Begin and End?</a></li>
  <li><a href="#workflow-basics" id="toc-workflow-basics" class="nav-link" data-scroll-target="#workflow-basics">Workflow Basics</a></li>
  <li><a href="#adding-raw-variables-to-the-workflow" id="toc-adding-raw-variables-to-the-workflow" class="nav-link" data-scroll-target="#adding-raw-variables-to-the-workflow">Adding Raw Variables to the <code>workflow()</code></a></li>
  <li>
<a href="#how-does-a-workflow-use-the-formula" id="toc-how-does-a-workflow-use-the-formula" class="nav-link" data-scroll-target="#how-does-a-workflow-use-the-formula">How Does a <code>workflow()</code> Use the Formula?</a>
  <ul class="collapse">
<li><a href="#special-formulas-and-inline-functions" id="toc-special-formulas-and-inline-functions" class="nav-link" data-scroll-target="#special-formulas-and-inline-functions">Special formulas and inline functions</a></li>
  </ul>
</li>
  <li><a href="#creating-multiple-workflows-at-once" id="toc-creating-multiple-workflows-at-once" class="nav-link" data-scroll-target="#creating-multiple-workflows-at-once">Creating Multiple Workflows at Once</a></li>
  <li><a href="#evaluating-the-test-set" id="toc-evaluating-the-test-set" class="nav-link" data-scroll-target="#evaluating-the-test-set">Evaluating the Test Set</a></li>
  <li><a href="#chapter-summary" id="toc-chapter-summary" class="nav-link" data-scroll-target="#chapter-summary">Chapter Summary</a></li>
  </ul></nav>
    <div class="quarto-margin-footer"><div class="margin-footer-item">
<p><img src="../..\logo.jpg" class="conditional-footer img-fluid" width="200"></p>
</div></div></div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">7 A Model Workflow</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 22, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">September 23, 2025</p>
    </div>
  </div>
    
  </div>
  


</header><p>在上一章中，我们讨论了parsnip包，该包可用于定义和拟合模型。本章将介绍一个名为<strong>模型工作流</strong>的新概念。这一概念（以及相应的<code>workflow()</code>对象）的目的是封装建模过程中的主要部分（在1.5节中讨论）。工作流的重要性体现在两个方面：首先，使用工作流概念有助于形成良好的方法体系，因为它是数据分析中估计部分的单一入口；其次，它能让用户更好地组织项目。这两点将在以下各节中详细讨论。</p>
<section id="where-does-the-model-begin-and-end" class="level2"><h2 class="anchored" data-anchor-id="where-does-the-model-begin-and-end">Where Does the Model Begin and End?</h2>
<p>到目前为止，当我们使用“模型”这一术语时，指的是将一些预测变量与一个或多个结果变量相关联的结构方程。让我们再以线性回归为例来思考。结果数据表示为yᵢ，其中训练集中有i=1…n个样本。假设模型中使用了p个预测变量xᵢ₁，…，xᵢₚ。线性回归会生成一个模型方程：$ _i = _0 + <em>1x</em>{i1} + + <em>px</em>{ip} $ 。虽然这是一个线性模型，但它仅在参数上是线性的。预测变量可以是非线性项（例如<code>log(xi)</code>）。</p>
<p>关于建模过程的传统思路是，它只包含模型拟合。对于一些简单的数据集，拟合模型本身可能就是整个过程。然而，在拟合模型之前，通常会有多种选择和额外的步骤：</p>
<ul>
<li><p>虽然我们的示例模型有p个预测变量，但通常一开始会有多于p个的候选预测变量。通过探索性数据分析或运用领域知识，一些预测变量可能会被排除在分析之外。在其他情况下，可以使用特征选择算法，以数据驱动的方式为模型选择最小的预测变量集。</p></li>
<li><p>在某些情况下，重要预测变量的值会缺失。此时，我们不必将该样本从数据集中剔除，而是可以利用数据中的其他值来填补这个缺失值。例如，如果x₁的值缺失，但它与预测变量x₂和x₃相关，那么一种填补方法就可以根据x₂和x₃的值来估计缺失的x₁观测值。</p></li>
<li><p>转换预测变量的尺度可能是有益的。如果没有关于新尺度应该是什么的先验信息，我们可以使用统计转换技术、现有数据和一些优化准则来估计合适的尺度。其他转换方法，如主成分分析（PCA），会对一组预测变量进行转换，将它们变成新的特征，用作预测变量。</p></li>
</ul>
<p>虽然这些例子都与模型拟合前的步骤有关，但在模型创建后也可能会有一些操作。当创建的分类模型其结果为二元时（例如，event和non-event），通常会使用50%的概率阈值来生成离散的类别预测，这也被称为硬预测。例如，某个分类模型可能会估计某一事件发生的概率为62%。按照通常的默认设置，硬预测结果会是event。然而，该模型可能需要更专注于减少假阳性结果（即，将真正的非事件错误地分类为事件的情况）。实现这一点的一种方法是将阈值从50%提高到某个更高的值。这会提高将新样本判定为事件所需的证据级别。虽然这会降低真阳性率（这是不利的），但它在减少假阳性方面可能会产生更显著的效果。阈值的选择应该利用数据进行优化。这是一个后处理步骤的例子，它对模型的运行效果有着重大影响，尽管它并不包含在模型拟合步骤中。</p>
<p>关注更广泛的建模过程很重要，而不仅仅是拟合用于估计参数的特定模型。这个更广泛的过程包括<strong>任何预处理步骤、模型拟合本身以及潜在的后处理活动</strong>。在本书中，我们将把这个更全面的概念称为<strong>模型工作流</strong>(model workflow)，并重点介绍如何处理其所有组成部分以生成最终的模型方程。在其他软件中，例如Python或Spark，类似的步骤集合被称为管道。在tidymodels中，“管道（pipeline）”一词已经表示通过管道运算符（例如magrittr包中的<code>%&gt;%</code>或更新的原生<code>|&gt;</code>）链接在一起的一系列操作。为了避免在此语境中使用模糊的术语，我们将与建模相关的一系列计算操作称为工作流。</p>
<p>将数据分析的分析组件整合在一起还有另一个重要原因。后续章节将展示如何准确衡量性能，以及如何优化结构参数（即模型调优）。为了正确量化模型在训练集上的性能，第10章提倡使用重采样方法。要正确做到这一点，分析中任何数据驱动的部分都不应被排除在验证之外。为此，工作流程必须包含所有重要的估计步骤。</p>
<p>举个例子，考虑主成分分析（PCA）信号提取。我们将在第8.4节和第16章中对此进行更详细的讨论；PCA是一种用新的人工特征替代相关预测变量的方法，这些新特征不相关，并且能捕捉原始集合中的大部分信息。这些新特征可以用作预测变量，而最小二乘回归可以用来估计模型参数。</p>
<p>关于模型工作流有两种思考方式。<a href="#fig-7.1" class="quarto-xref">Figure&nbsp;1</a> 展示了错误的方法：将主成分分析（PCA）预处理步骤视为不属于建模工作流的一部分。</p>
<div id="fig-7.1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-7.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/bad-workflow.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-7.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Incorrect mental model of where model estimation occurs in the data analysis process
</figcaption></figure>
</div>
<p>这里的谬误在于，尽管主成分分析（PCA）为生成主成分进行了大量计算，但其运算被假定为不存在任何相关的不确定性。主成分分析的主成分被视为已知的，而且如果不将其纳入模型工作流，就无法充分衡量主成分分析的效果。</p>
<p><a href="#fig-7.2" class="quarto-xref">Figure&nbsp;2</a> 展示了一种恰当的方法。</p>
<div id="fig-7.2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-7.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/proper-workflow.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-7.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Correct mental model of where model estimation occurs in the data analysis process
</figcaption></figure>
</div>
<p>通过这种方式，主成分分析预处理被视为建模过程的一部分。</p>
</section><section id="workflow-basics" class="level2"><h2 class="anchored" data-anchor-id="workflow-basics">Workflow Basics</h2>
<p>workflows包允许用户将建模对象和预处理对象绑定在一起。让我们再次从Ames数据和一个简单的线性模型开始：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Attaching packages ─────────────────────────────────── tidymodels 1.4.1 ──</span></span>
<span><span class="co">#&gt; ✔ broom        1.0.9     ✔ recipes      1.3.1</span></span>
<span><span class="co">#&gt; ✔ dials        1.4.2     ✔ rsample      1.3.1</span></span>
<span><span class="co">#&gt; ✔ dplyr        1.1.4     ✔ tailor       0.1.0</span></span>
<span><span class="co">#&gt; ✔ ggplot2      3.5.2     ✔ tidyr        1.3.1</span></span>
<span><span class="co">#&gt; ✔ infer        1.0.9     ✔ tune         2.0.0</span></span>
<span><span class="co">#&gt; ✔ modeldata    1.5.1     ✔ workflows    1.3.0</span></span>
<span><span class="co">#&gt; ✔ parsnip      1.3.3     ✔ workflowsets 1.1.1</span></span>
<span><span class="co">#&gt; ✔ purrr        1.1.0     ✔ yardstick    1.3.2</span></span>
<span><span class="co">#&gt; ── Conflicts ────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ purrr::discard() masks scales::discard()</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter()  masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()     masks stats::lag()</span></span>
<span><span class="co">#&gt; ✖ recipes::step()  masks stats::step()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ames</span><span class="op">)</span></span>
<span><span class="va">ames</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">ames</span>, Sale_Price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">Sale_Price</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">502</span><span class="op">)</span></span>
<span><span class="va">ames_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">ames</span>, prop <span class="op">=</span> <span class="fl">0.80</span>, strata <span class="op">=</span> <span class="va">Sale_Price</span><span class="op">)</span></span>
<span><span class="va">ames_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">ames_split</span><span class="op">)</span></span>
<span><span class="va">ames_test</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">ames_split</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_model</span> <span class="op">&lt;-</span> <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>工作流始终需要一个parsnip模型对象：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_wflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lm_model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_wflow</span></span>
<span><span class="co">#&gt; ══ Workflow ═════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: None</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Linear Regression Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: lm</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>请注意，我们尚未指定此工作流应如何预处理数据：<code>Preprocessor: None</code>。如果我们的模型非常简单，可以使用标准的R公式作为预处理器：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_wflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lm_wflow</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span><span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Longitude</span> <span class="op">+</span> <span class="va">Latitude</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_wflow</span></span>
<span><span class="co">#&gt; ══ Workflow ═════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Formula</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Sale_Price ~ Longitude + Latitude</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Linear Regression Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: lm</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>工作流有一个<code><a href="https://generics.r-lib.org/reference/fit.html">fit()</a></code>方法，可用于创建模型。使用在第6.6节中创建的对象：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">lm_wflow</span>, <span class="va">ames_train</span><span class="op">)</span></span>
<span><span class="va">lm_fit</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ═══════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Formula</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Sale_Price ~ Longitude + Latitude</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; stats::lm(formula = ..y ~ ., data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)    Longitude     Latitude  </span></span>
<span><span class="co">#&gt;    -302.974       -2.075        2.710</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>我们还可以在拟合的工作流上使用<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_fit</span>, <span class="va">ames_test</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 1</span></span>
<span><span class="co">#&gt;   .pred</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  5.22</span></span>
<span><span class="co">#&gt; 2  5.21</span></span>
<span><span class="co">#&gt; 3  5.28</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>方法遵循我们在6.3节中为parsnip包描述的所有相同规则和命名约定。模型和预处理器都可以被移除或更新：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_fit</span> <span class="op">%&gt;%</span> <span class="fu">update_formula</span><span class="op">(</span><span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Longitude</span><span class="op">)</span></span>
<span><span class="co">#&gt; ══ Workflow ═════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Formula</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Sale_Price ~ Longitude</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Linear Regression Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: lm</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>请注意，在这个新对象中，输出显示之前拟合的模型已被移除，因为新公式与之前的模型拟合不一致。</p>
</section><section id="adding-raw-variables-to-the-workflow" class="level2"><h2 class="anchored" data-anchor-id="adding-raw-variables-to-the-workflow">Adding Raw Variables to the <code>workflow()</code>
</h2>
<p>还有另一种向模型传递数据的接口，即<code>add_variables()</code>函数，它使用类dplyr的语法来选择变量。该函数有两个主要参数：<code>outcomes</code>（结果）和<code>predictors</code>（预测变量）。它们采用类似于tidyverse包的tidyselect后端的选择方法，通过<code><a href="https://rdrr.io/r/base/c.html">c()</a></code>来捕获多个选择器。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_wflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lm_wflow</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">remove_formula</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_variables</span><span class="op">(</span>outcome <span class="op">=</span> <span class="va">Sale_Price</span>, predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Longitude</span>, <span class="va">Latitude</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lm_wflow</span></span>
<span><span class="co">#&gt; ══ Workflow ═════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Variables</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Outcomes: Sale_Price</span></span>
<span><span class="co">#&gt; Predictors: c(Longitude, Latitude)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Linear Regression Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: lm</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>也可以使用更通用的选择器来指定预测变量，例如：<code>predictors = c(ends_with("tude"))</code>。一个便利之处在于，任何意外地在predictors参数中指定的结果列都会被悄无声息地移除。这为以下用法提供了便利：<code>predictors = everything()</code>。</p>
<p>当模型拟合时，该声明会将这些数据原封不动地整合到一个数据框中，并将其传递给底层函数：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fit</span><span class="op">(</span><span class="va">lm_wflow</span>, <span class="va">ames_train</span><span class="op">)</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ═══════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Variables</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Outcomes: Sale_Price</span></span>
<span><span class="co">#&gt; Predictors: c(Longitude, Latitude)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; stats::lm(formula = ..y ~ ., data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)    Longitude     Latitude  </span></span>
<span><span class="co">#&gt;    -302.974       -2.075        2.710</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>如果你希望底层建模方法按其通常的方式处理数据，<code>add_variables()</code>会是一个有用的接口。正如我们将在第7.4.1节中看到的，它还能促进更复杂的建模规范。不过，正如我们在下一节中提到的，像<code>glmnet</code>和<code>xgboost</code>这样的模型期望用户从因子预测变量中创建指示变量。在这些情况下，recipe或公式接口通常会是更好的选择。我们将在下一章中介绍更强大的预处理工具——recipe，它也可以添加到工作流程中。</p>
</section><section id="how-does-a-workflow-use-the-formula" class="level2"><h2 class="anchored" data-anchor-id="how-does-a-workflow-use-the-formula">How Does a <code>workflow()</code> Use the Formula?</h2>
<p>回顾第3.2节可知，R语言中的公式方法有多种用途（我们将在第8章进一步讨论这一点）。其中之一是将原始数据正确编码为便于分析的格式。这可能包括执行内嵌转换（例如<code>log(x)</code>）、创建虚拟变量列、创建交互项或其他列扩展等。然而，许多统计方法需要不同类型的编码：</p>
<ul>
<li><p>大多数基于树的模型的R包使用公式接口，但不会将分类预测变量编码为虚拟变量。</p></li>
<li><p>某些R包会使用特殊的内联函数来告知模型函数在分析中如何处理预测变量。例如，在生存分析模型中，像<code>strata(site)</code>这样的公式项会表明列<code>site</code>是一个分层变量。这意味着它不应被当作常规预测变量来处理，并且在模型中没有相应的位置参数估计。</p></li>
<li><p>有几个R包以base R函数无法解析或执行的方式扩展了公式。在多水平模型（例如混合模型或分层贝叶斯模型）中，诸如<code>(week | subject)</code>这样的模型项表示列<code>week</code>是一个随机效应，其对于<code>subject</code>列的每个值都有不同的斜率参数估计。</p></li>
</ul>
<p>工作流是一种通用接口。当使用<code>add_formula()</code>时，工作流应该如何对数据进行预处理？由于预处理取决于模型，工作流会尽可能模仿底层模型的做法。如果无法做到这一点，公式处理不应对公式中使用的列进行任何操作。让我们更详细地看看这一点。</p>
<section id="special-formulas-and-inline-functions" class="level3"><h3 class="anchored" data-anchor-id="special-formulas-and-inline-functions">Special formulas and inline functions</h3>
<p>许多多层模型已经采用了<strong>lme4</strong>包中设计的公式规范。例如，要拟合一个包含受试者随机效应的回归模型，我们会使用下面的公式。其结果是，每个受试者都会有一个针对<code>age</code>的估计截距和斜率参数。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'Matrix'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:tidyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     expand, pack, unpack</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/">nlme</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'nlme'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:lme4':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     lmList</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">~</span> <span class="va">Sex</span> <span class="op">+</span> <span class="op">(</span><span class="va">age</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">Orthodont</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: distance ~ Sex + (age | Subject)</span></span>
<span><span class="co">#&gt;    Data: Orthodont</span></span>
<span><span class="co">#&gt; REML criterion at convergence: 471.1635</span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Std.Dev. Corr </span></span>
<span><span class="co">#&gt;  Subject  (Intercept) 7.3912        </span></span>
<span><span class="co">#&gt;           age         0.6943   -0.97</span></span>
<span><span class="co">#&gt;  Residual             1.3100        </span></span>
<span><span class="co">#&gt; Number of obs: 108, groups:  Subject, 27</span></span>
<span><span class="co">#&gt; Fixed Effects:</span></span>
<span><span class="co">#&gt; (Intercept)    SexFemale  </span></span>
<span><span class="co">#&gt;      24.517       -2.145</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>标准的R方法无法正确处理这个公式，导致生成一个0行的数据框：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">~</span> <span class="va">Sex</span> <span class="op">+</span> <span class="op">(</span><span class="va">age</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">Orthodont</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in Ops.ordered(age, Subject): '|' is not meaningful for ordered</span></span>
<span><span class="co">#&gt; factors</span></span>
<span><span class="co">#&gt;      (Intercept) SexFemale age | SubjectTRUE</span></span>
<span><span class="co">#&gt; attr(,"assign")</span></span>
<span><span class="co">#&gt; [1] 0 1 2</span></span>
<span><span class="co">#&gt; attr(,"contrasts")</span></span>
<span><span class="co">#&gt; attr(,"contrasts")$Sex</span></span>
<span><span class="co">#&gt; [1] "contr.treatment"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"contrasts")$`age | Subject`</span></span>
<span><span class="co">#&gt; [1] "contr.treatment"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>这个特殊公式必须由底层的包代码来处理，而不是标准的<code><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix()</a></code>方法。即使这个公式可以与<code><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix()</a></code>一起使用，这仍然会带来问题，因为该公式还指定了模型的统计属性。workflows中的解决方案是使用<code>add_model()</code>补充模型公式——<code>add_variables()</code>明确了预测因子和结果的列名，<code>add_model()</code>中提供实际公式：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/multilevelmod">multilevelmod</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">multilevel_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"lmer"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">multilevel_workflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Pass the data along as-is:</span></span>
<span>  <span class="fu">add_variables</span><span class="op">(</span>outcome <span class="op">=</span> <span class="va">distance</span>, predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Sex</span>, <span class="va">age</span>, <span class="va">Subject</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">multilevel_spec</span>,</span>
<span>    <span class="co"># This formula is given to the model</span></span>
<span>    formula <span class="op">=</span> <span class="va">distance</span> <span class="op">~</span> <span class="va">Sex</span> <span class="op">+</span> <span class="op">(</span><span class="va">age</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">multilevel_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">multilevel_workflow</span>, data <span class="op">=</span> <span class="va">Orthodont</span><span class="op">)</span></span>
<span><span class="va">multilevel_fit</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ═══════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Variables</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Outcomes: distance</span></span>
<span><span class="co">#&gt; Predictors: c(Sex, age, Subject)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: distance ~ Sex + (age | Subject)</span></span>
<span><span class="co">#&gt;    Data: data</span></span>
<span><span class="co">#&gt; REML criterion at convergence: 471.1635</span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Std.Dev. Corr </span></span>
<span><span class="co">#&gt;  Subject  (Intercept) 7.3912        </span></span>
<span><span class="co">#&gt;           age         0.6943   -0.97</span></span>
<span><span class="co">#&gt;  Residual             1.3100        </span></span>
<span><span class="co">#&gt; Number of obs: 108, groups:  Subject, 27</span></span>
<span><span class="co">#&gt; Fixed Effects:</span></span>
<span><span class="co">#&gt; (Intercept)    SexFemale  </span></span>
<span><span class="co">#&gt;      24.517       -2.145</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>我们甚至可以使用前面提到的生存分析包（<strong>survival</strong>）中的<code><a href="https://rdrr.io/pkg/survival/man/strata.html">strata()</a></code>函数来进行生存分析：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/censored">censored</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: survival</span></span>
<span></span>
<span><span class="va">parametric_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/survival_reg.html">survival_reg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parametric_workflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_variables</span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fustat</span>, <span class="va">futime</span><span class="op">)</span>, predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">rx</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">parametric_spec</span>,</span>
<span>    formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">futime</span>, <span class="va">fustat</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html">strata</a></span><span class="op">(</span><span class="va">rx</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">parametric_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">parametric_workflow</span>, data <span class="op">=</span> <span class="va">ovarian</span><span class="op">)</span></span>
<span><span class="va">parametric_fit</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ═══════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Variables</span></span>
<span><span class="co">#&gt; Model: survival_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Outcomes: c(fustat, futime)</span></span>
<span><span class="co">#&gt; Predictors: c(age, rx)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; survival::survreg(formula = Surv(futime, fustat) ~ age + strata(rx), </span></span>
<span><span class="co">#&gt;     data = data, model = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)         age </span></span>
<span><span class="co">#&gt;  12.8734120  -0.1033569 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scale:</span></span>
<span><span class="co">#&gt;      rx=1      rx=2 </span></span>
<span><span class="co">#&gt; 0.7695509 0.4703602 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Loglik(model)= -89.4   Loglik(intercept only)= -97.1</span></span>
<span><span class="co">#&gt;  Chisq= 15.36 on 1 degrees of freedom, p= 8.88e-05 </span></span>
<span><span class="co">#&gt; n= 26</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section></section><section id="creating-multiple-workflows-at-once" class="level2"><h2 class="anchored" data-anchor-id="creating-multiple-workflows-at-once">Creating Multiple Workflows at Once</h2>
<p>在某些情况下，数据需要多次尝试才能找到合适的模型。例如：</p>
<ul>
<li><p>对于预测模型，建议评估多种不同的模型类型。这需要用户创建多个模型规格。</p></li>
<li><p>模型的序贯检验通常从一组扩展的预测变量开始。这种“全模型”会与一系列相同的模型进行比较，这些模型依次移除了每个预测变量。通过基本的假设检验方法或经验验证，可以分离并评估每个预测变量的影响。</p></li>
</ul>
<p>在这些情况下以及其他一些情况中，根据不同的预处理程序集和/或模型规格创建大量工作流可能会变得繁琐或繁重。为了解决这个问题，<strong>workflowset</strong>包会创建工作流组件的组合。一系列预处理程序（例如公式、dplyr选择器，或下一章将讨论的特征工程recipe对象）可以与一系列模型规格相结合，从而生成一套工作流。</p>
<p>举个例子，假设我们想重点关注Ames数据中房屋位置的不同表示方式。我们可以创建一组公式来捕捉这些预测变量：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  longitude <span class="op">=</span> <span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Longitude</span>,</span>
<span>  latitude <span class="op">=</span> <span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Latitude</span>,</span>
<span>  coords <span class="op">=</span> <span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Longitude</span> <span class="op">+</span> <span class="va">Latitude</span>,</span>
<span>  neighborhood <span class="op">=</span> <span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Neighborhood</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>可以使用<code><a href="https://workflowsets.tidymodels.org/reference/workflow_set.html">workflow_set()</a></code>函数将这些表示形式与一个或多个模型进行组合。我们将仅使用之前的线性模型规格来进行演示：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflowsets">workflowsets</a></span><span class="op">)</span></span>
<span><span class="va">location_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://workflowsets.tidymodels.org/reference/workflow_set.html">workflow_set</a></span><span class="op">(</span>preproc <span class="op">=</span> <span class="va">location</span>, models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lm <span class="op">=</span> <span class="va">lm_model</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">location_models</span></span>
<span><span class="co">#&gt; # A workflow set/tibble: 4 × 4</span></span>
<span><span class="co">#&gt;   wflow_id        info             option    result    </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;           &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    </span></span>
<span><span class="co">#&gt; 1 longitude_lm    &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</span></span>
<span><span class="co">#&gt; 2 latitude_lm     &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</span></span>
<span><span class="co">#&gt; 3 coords_lm       &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</span></span>
<span><span class="co">#&gt; 4 neighborhood_lm &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</span></span>
<span><span class="va">location_models</span><span class="op">$</span><span class="va">info</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 4</span></span>
<span><span class="co">#&gt;   workflow   preproc model      comment</span></span>
<span><span class="co">#&gt;   &lt;list&gt;     &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 &lt;workflow&gt; formula linear_reg ""</span></span>
<span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html">extract_workflow</a></span><span class="op">(</span><span class="va">location_models</span>, id <span class="op">=</span> <span class="st">"coords_lm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ══ Workflow ═════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Formula</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Sale_Price ~ Longitude + Latitude</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Linear Regression Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: lm</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>工作流集主要设计用于处理重采样，这在第10章中会进行讨论。<code>option</code>列和<code>result</code>列必须填充从重采样中得到的特定类型的对象。我们将在第11章和第15章中更详细地演示这一点。</p>
<p>与此同时，让我们为每个公式创建模型拟合，并将它们保存在一个名为<code>fit</code>的新列中。我们将使用基本的dplyr和purrr操作：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">location_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">location_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fit <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">info</span>, <span class="op">~</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">workflow</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ames_train</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">location_models</span></span>
<span><span class="co">#&gt; # A workflow set/tibble: 4 × 5</span></span>
<span><span class="co">#&gt;   wflow_id        info             option    result     fit       </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;           &lt;list&gt;           &lt;list&gt;    &lt;list&gt;     &lt;list&gt;    </span></span>
<span><span class="co">#&gt; 1 longitude_lm    &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt; &lt;workflow&gt;</span></span>
<span><span class="co">#&gt; 2 latitude_lm     &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt; &lt;workflow&gt;</span></span>
<span><span class="co">#&gt; 3 coords_lm       &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt; &lt;workflow&gt;</span></span>
<span><span class="co">#&gt; 4 neighborhood_lm &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt; &lt;workflow&gt;</span></span>
<span><span class="va">location_models</span><span class="op">$</span><span class="va">fit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ═══════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Formula</span></span>
<span><span class="co">#&gt; Model: linear_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Sale_Price ~ Longitude</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; stats::lm(formula = ..y ~ ., data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)    Longitude  </span></span>
<span><span class="co">#&gt;    -184.396       -2.025</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>我们在这里使用了一个purrr函数来遍历我们的模型，但有一种更简单、更好的方法来拟合工作流集合，这将在第11.1节中介绍。</p>
<p>总的来说，工作流集还有很多内容值得探讨！虽然我们在这里介绍了基础知识，但工作流集的细微差别和优势要到第15章才会详细阐述。</p>
</section><section id="evaluating-the-test-set" class="level2"><h2 class="anchored" data-anchor-id="evaluating-the-test-set">Evaluating the Test Set</h2>
<p>假设我们已经完成了模型开发，并确定了最终模型。有一个便捷函数叫做<code>last_fit()</code>，它会用整个训练集对模型进行拟合，并用测试集对其进行评估。</p>
<p>以<code>lm_wflow</code>为例，我们可以将模型以及初始的训练/测试集拆分传递给该函数：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">final_lm_res</span> <span class="op">&lt;-</span> <span class="fu">last_fit</span><span class="op">(</span><span class="va">lm_wflow</span>, <span class="va">ames_split</span><span class="op">)</span></span>
<span><span class="va">final_lm_res</span></span>
<span><span class="co">#&gt; # Resampling results</span></span>
<span><span class="co">#&gt; # Manual resampling </span></span>
<span><span class="co">#&gt; # A tibble: 1 × 6</span></span>
<span><span class="co">#&gt;   splits             id               .metrics         .notes   .predictions</span></span>
<span><span class="co">#&gt;   &lt;list&gt;             &lt;chr&gt;            &lt;list&gt;           &lt;list&gt;   &lt;list&gt;      </span></span>
<span><span class="co">#&gt; 1 &lt;split [2342/588]&gt; train/test split &lt;tibble [2 × 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    </span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: .workflow &lt;list&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>请注意，<code>last_fit()</code>接受的数据是已分割的，而不是原始数据框。该函数使用此分割好的数据集来生成用于最终拟合和评估的训练集和测试集。</p>
<p><code>.workflow</code>列包含拟合的工作流，可以使用以下代码从结果中提取出来：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fitted_lm_wflow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html">extract_workflow</a></span><span class="op">(</span><span class="va">final_lm_res</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>同样地，<code><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_metrics()</a></code>和<code><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_predictions()</a></code>分别提供了获取性能指标和预测结果的途径。</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_metrics</a></span><span class="op">(</span><span class="va">final_lm_res</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric .estimator .estimate .config        </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;          </span></span>
<span><span class="co">#&gt; 1 rmse    standard       0.164 pre0_mod0_post0</span></span>
<span><span class="co">#&gt; 2 rsq     standard       0.189 pre0_mod0_post0</span></span>
<span><span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html">collect_predictions</a></span><span class="op">(</span><span class="va">final_lm_res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 5</span></span>
<span><span class="co">#&gt;   .pred id               Sale_Price  .row .config        </span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;          </span></span>
<span><span class="co">#&gt; 1  5.22 train/test split       5.02     2 pre0_mod0_post0</span></span>
<span><span class="co">#&gt; 2  5.21 train/test split       5.39     4 pre0_mod0_post0</span></span>
<span><span class="co">#&gt; 3  5.28 train/test split       5.28     5 pre0_mod0_post0</span></span>
<span><span class="co">#&gt; 4  5.27 train/test split       5.28     8 pre0_mod0_post0</span></span>
<span><span class="co">#&gt; 5  5.28 train/test split       5.28    10 pre0_mod0_post0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>我们将在16.6节中进一步了解<code>last_fit()</code>的实际应用以及如何再次使用它。</p>
<p>在使用验证集时，<code>last_fit()</code>有一个名为<code>add_validation_set</code>的参数，用于指定最终模型是仅在训练集上训练（默认设置），还是在训练集和验证集的组合上训练。</p>
</section><section id="chapter-summary" class="level2"><h2 class="anchored" data-anchor-id="chapter-summary">Chapter Summary</h2>
<p>在本章中，你了解到建模过程不仅仅包括估计将预测变量与结果联系起来的算法参数。这个过程还包括预处理步骤以及模型拟合后的操作。我们引入了一个名为模型工作流的概念，它可以捕捉建模过程中的重要组成部分。多个工作流也可以在一个工作流集合中创建。<code>last_fit()</code>函数便于将最终模型拟合到训练集并使用测试集进行评估。</p>
<p>对于Ames数据集，其使用的相关代码如下：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ames</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ames</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">ames</span>, Sale_Price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">Sale_Price</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">502</span><span class="op">)</span></span>
<span><span class="va">ames_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">ames</span>, prop <span class="op">=</span> <span class="fl">0.80</span>, strata <span class="op">=</span> <span class="va">Sale_Price</span><span class="op">)</span></span>
<span><span class="va">ames_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">ames_split</span><span class="op">)</span></span>
<span><span class="va">ames_test</span>  <span class="op">&lt;-</span>  <span class="fu">testing</span><span class="op">(</span><span class="va">ames_split</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_wflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lm_model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_variables</span><span class="op">(</span>outcome <span class="op">=</span> <span class="va">Sale_Price</span>, predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Longitude</span>, <span class="va">Latitude</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">lm_wflow</span>, <span class="va">ames_train</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>


</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><script src="https://utteranc.es/client.js" repo="hanguojun007/Blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../Books/Tidy Modeling with R/6 Fitting Models with parsnip.html" class="pagination-link" aria-label="6 Fitting Models with parsnip">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">6 Fitting Models with parsnip</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../Books/Tidy Modeling with R/8 Feature Engineering with recipes.html" class="pagination-link" aria-label="8 Feature Engineering with recipes">
        <span class="nav-page-text">8 Feature Engineering with recipes</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>