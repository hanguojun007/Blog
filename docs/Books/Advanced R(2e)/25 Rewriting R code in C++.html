<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="dcterms.date" content="2025-08-30">
<title>25 Rewriting R code in C++</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../Books/Advanced R(2e)/24 Improving performance.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e6e594f9697a8fc74d922f689f62e840.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "Search",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">RSSPtho</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-books" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Books</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-books">
<li>
    <a class="dropdown-item" href="../../Books/ggplot2/index.html">
 <span class="dropdown-text">ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/R4DS2/index.html">
 <span class="dropdown-text">R for Data Science(2e)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/Tidy Modeling with R/index.html">
 <span class="dropdown-text">Tidy Modeling with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/Advanced R(2e)/index.html">
 <span class="dropdown-text">Advanced R(2e)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/quarto/Project Basics.html">
 <span class="dropdown-text">Quarto</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Books/Js4R/00 Preface.html">
 <span class="dropdown-text">Js4R</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About me</span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
    <a href="https://github.com/hanguojun007" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Books/Advanced R(2e)/25 Rewriting R code in C++.html">25 Rewriting R code in C++</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/1 Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">Foundations</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/Foundations Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/2 Names and values.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 Names and values</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/3 Vectors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 Vectors</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/4 Subsetting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 Subsetting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/5 Control flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5 Control flow</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/6 Functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6 Functions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/7 Environments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7 Environments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/8 Conditions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8 Conditions</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">Functional programming</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/Functional programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/9 Functionals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9 Functionals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/10 Function factories.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 Function factories</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/11 Function operators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 Function operators</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">Object-oriented Programming</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/Object-oriented Programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/12 Base types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 Base types</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/13 S3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13 S3</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/14 R6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">14 R6</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/15 S4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">15 S4</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/16 Trade-offs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">16 Trade-offs</span></a>
  </div>
</li>
        <li class="sidebar-item">
 <span class="menu-text">Metaprogramming</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/Metaprogramming Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/17 Big picture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">17 Big picture</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/18 Expressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">18 Expressions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/19 Quasiquotation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">19 Quasiquotation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/20 Evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">20 Evaluation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/21 Translating R code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">21 Translating R code</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/Techniques Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/22 Debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">22 Debugging</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/23 Measuring performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">23 Measuring performance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/24 Improving performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">24 Improving performance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Books/Advanced R(2e)/25 Rewriting R code in C++.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">25 Rewriting R code in C++</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
<li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a></li>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  </ul>
</li>
  <li>
<a href="#getting-started-with-c" id="toc-getting-started-with-c" class="nav-link" data-scroll-target="#getting-started-with-c">Getting started with C++</a>
  <ul class="collapse">
<li><a href="#no-inputs-scalar-output" id="toc-no-inputs-scalar-output" class="nav-link" data-scroll-target="#no-inputs-scalar-output">No inputs, scalar output</a></li>
  <li><a href="#scalar-input-scalar-output" id="toc-scalar-input-scalar-output" class="nav-link" data-scroll-target="#scalar-input-scalar-output">Scalar input, scalar output</a></li>
  <li><a href="#vector-input-scalar-output" id="toc-vector-input-scalar-output" class="nav-link" data-scroll-target="#vector-input-scalar-output">Vector input, scalar output</a></li>
  <li><a href="#vector-input-vector-output" id="toc-vector-input-vector-output" class="nav-link" data-scroll-target="#vector-input-vector-output">Vector input, vector output</a></li>
  <li><a href="#using-sourcecpp" id="toc-using-sourcecpp" class="nav-link" data-scroll-target="#using-sourcecpp">Using sourceCpp</a></li>
  </ul>
</li>
  <li>
<a href="#other-classes" id="toc-other-classes" class="nav-link" data-scroll-target="#other-classes">Other classes</a>
  <ul class="collapse">
<li><a href="#lists-and-data-frames" id="toc-lists-and-data-frames" class="nav-link" data-scroll-target="#lists-and-data-frames">Lists and data frames</a></li>
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions">Functions</a></li>
  <li><a href="#attributes" id="toc-attributes" class="nav-link" data-scroll-target="#attributes">Attributes</a></li>
  </ul>
</li>
  <li>
<a href="#missing-values" id="toc-missing-values" class="nav-link" data-scroll-target="#missing-values">Missing values</a>
  <ul class="collapse">
<li><a href="#scalars" id="toc-scalars" class="nav-link" data-scroll-target="#scalars">Scalars</a></li>
  <li><a href="#vectors" id="toc-vectors" class="nav-link" data-scroll-target="#vectors">Vectors</a></li>
  </ul>
</li>
  <li>
<a href="#standard-template-library" id="toc-standard-template-library" class="nav-link" data-scroll-target="#standard-template-library">Standard Template Library</a>
  <ul class="collapse">
<li><a href="#using-iterators" id="toc-using-iterators" class="nav-link" data-scroll-target="#using-iterators">Using iterators</a></li>
  <li><a href="#algorithms" id="toc-algorithms" class="nav-link" data-scroll-target="#algorithms">Algorithms</a></li>
  <li><a href="#data-structures" id="toc-data-structures" class="nav-link" data-scroll-target="#data-structures">Data structures</a></li>
  </ul>
</li>
  <li>
<a href="#case-studies" id="toc-case-studies" class="nav-link" data-scroll-target="#case-studies">Case studies</a>
  <ul class="collapse">
<li><a href="#gibbs-sampler" id="toc-gibbs-sampler" class="nav-link" data-scroll-target="#gibbs-sampler">Gibbs sampler</a></li>
  <li><a href="#r-vectorisation-versus-c-vectorisation" id="toc-r-vectorisation-versus-c-vectorisation" class="nav-link" data-scroll-target="#r-vectorisation-versus-c-vectorisation">R vectorisation versus C++ vectorisation</a></li>
  </ul>
</li>
  <li><a href="#using-rcpp-in-a-package" id="toc-using-rcpp-in-a-package" class="nav-link" data-scroll-target="#using-rcpp-in-a-package">Using Rcpp in a package</a></li>
  <li><a href="#learning-more" id="toc-learning-more" class="nav-link" data-scroll-target="#learning-more">Learning more</a></li>
  </ul></nav>
    <div class="quarto-margin-footer"><div class="margin-footer-item">
<p><img src="../..\logo.jpg" class="conditional-footer img-fluid" width="200"></p>
</div></div></div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">25 Rewriting R code in C++</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 30, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">September 6, 2025</p>
    </div>
  </div>
    
  </div>
  


</header><section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>æœ‰æ—¶ï¼Œå³ä¾¿ä½ æ‰¾å‡ºæ¥ä»£ç çš„è¿è¡Œç“¶é¢ˆï¼ŒåŒæ—¶åšäº†æ‰€æœ‰å¯ä»¥åœ¨Rä¸­åšçš„ä¼˜åŒ–ï¼Œè¿è¡Œä¾ç„¶å¾ˆæ…¢ã€‚è¿™ä»…ä»…æ˜¯å› ä¸ºRæœ¬èº«å°±æ˜¯æ…¢ï¼ˆğŸ¤¦â€ï¼‰ã€‚æœ¬ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨â€œRcppâ€åŒ…å®ç°ç”¨C++é‡å†™å…³é”®å‡½æ•°æ¥æå‡æ€§èƒ½ã€‚</p>
<p>â€œRcppâ€åŒ…æä¾›äº†å¹²å‡€å¯åŠçš„APIæ¥å®ç°C++ä¸Rä¹‹é—´çš„é“¾æ¥ï¼ŒåŒæ—¶éš”ç¦»Ræœ¬èº«çš„å¤æ‚çš„Cçš„APIã€‚è™½ç„¶å®ƒä¹Ÿå¯ä»¥ç”¨æ¥äº›Cæˆ–Fortranä»£ç ï¼Œä½†ç›¸è¾ƒC++ç¨æ˜¾ç—›è‹¦ã€‚</p>
<p>C++å¯ä»¥ç”¨æ¥è§£æä¸‹é¢å…¸å‹çš„ç“¶é¢ˆï¼š</p>
<ul>
<li><p>æ— æ³•è½»æ˜“å‘é‡åŒ–çš„å¾ªç¯ï¼Œå› ä¸ºåç»­è¿­ä»£ä¾èµ–äºå…ˆå‰çš„è¿­ä»£ã€‚</p></li>
<li><p>é€’å½’å‡½æ•°ï¼Œæˆ–è€…æ¶‰åŠè°ƒç”¨å‡½æ•°æ•°ç™¾ä¸‡æ¬¡çš„é—®é¢˜ã€‚åœ¨C++ä¸­è°ƒç”¨å‡½æ•°çš„å¼€é”€æ¯”åœ¨Rä¸­ä½å¾—å¤šã€‚</p></li>
<li><p>éœ€è¦ä½¿ç”¨Ræ²¡æœ‰æä¾›çš„é«˜çº§æ•°æ®ç»“æ„å’Œç®—æ³•çš„é—®é¢˜ã€‚é€šè¿‡æ ‡å‡†æ¨¡æ¿åº“ï¼ˆSTLï¼‰ï¼ŒC++é«˜æ•ˆåœ°å®ç°äº†è®¸å¤šé‡è¦çš„æ•°æ®ç»“æ„ï¼Œä»æœ‰åºæ˜ å°„åˆ°åŒç«¯é˜Ÿåˆ—ã€‚</p></li>
</ul>
<p>æœ¬ç« çš„ç›®çš„æ˜¯ä»…è®¨è®ºC++å’Œâ€œRcppâ€çš„é‚£äº›ç»å¯¹å¿…è¦çš„æ–¹é¢ï¼Œä»¥å¸®åŠ©æ¶ˆé™¤ä»£ç ä¸­çš„ç“¶é¢ˆã€‚æˆ‘ä»¬ä¸ä¼šåœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹æˆ–æ¨¡æ¿ç­‰é«˜çº§åŠŸèƒ½ä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´ï¼Œå› ä¸ºé‡ç‚¹æ˜¯ç¼–å†™å°å‹ã€è‡ªåŒ…å«çš„å‡½æ•°ï¼Œè€Œä¸æ˜¯å¤§å‹ç¨‹åºã€‚C++çš„å·¥ä½œçŸ¥è¯†æ˜¯æœ‰ç”¨çš„ï¼Œä½†ä¸æ˜¯å¿…ä¸å¯å°‘çš„ã€‚è®¸å¤šä¼˜ç§€çš„æ•™ç¨‹å’Œå‚è€ƒèµ„æ–™å¯ä»¥å…è´¹è·å¾—ï¼ŒåŒ…æ‹¬ http://www.learncpp.com/ å’Œ https://en.cppreference.com/w/cpp ã€‚å¯¹äºæ›´é«˜çº§çš„ä¸»é¢˜ï¼ŒScott Meyersçš„â€œEffective C++â€ç³»åˆ—æ˜¯ä¸€ä¸ªå—æ¬¢è¿çš„é€‰æ‹©ã€‚</p>
<section id="outline" class="level3"><h3 class="anchored" data-anchor-id="outline">Outline</h3>
<ul>
<li>25.2èŠ‚ï¼šä»‹ç»å¦‚ä½•å°†ç®€å•çš„Rå‡½æ•°è½¬æ¢ä¸ºç­‰ä»·çš„C++å‡½æ•°ï¼Œå¹¶ä»¥æ­¤ä»‹ç»C++ä¸Rçš„ä¸åŒä¹‹å¤„ã€‚</li>
<li>25.2.5å°èŠ‚ï¼šä»‹ç»å¦‚ä½•ä½¿ç”¨<code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp()</a></code>å‡½æ•°åŠ è½½C++ä»£ç ã€‚</li>
<li>25.3èŠ‚ï¼šä»‹ç»å¦‚ä½•ä¿®æ”¹â€œRcppâ€ä¸­çš„å±æ€§ï¼Œå’Œä¸€äº›å…¶ä»–é‡è¦çš„ç±»ã€‚</li>
<li>25.4èŠ‚ï¼šä»‹ç»å¦‚ä½•åœ¨C++ä¸­å¤„ç†Rçš„ç¼ºå¤±å€¼ã€‚</li>
<li>25.5èŠ‚ï¼šä»‹ç»å¦‚ä½•ä½¿ç”¨æ ‡å‡†æ¨¡æ¿åº“ä¸­çš„ä¸€äº›é‡è¦æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚</li>
<li>25.6èŠ‚ï¼šä»‹ç»ä¸¤ä¸ªä½¿ç”¨â€œRcppâ€æå¤§æå‡æ€§èƒ½çš„ä¾‹å­ã€‚</li>
<li>25.7èŠ‚ï¼šä»‹ç»å¦‚ä½•å°†C++ä»£ç æ·»åŠ åˆ°RåŒ…ä¸­ã€‚</li>
<li>25.8èŠ‚ï¼šä»‹ç»æ›´å¤šæœ‰å…³â€œRcppâ€çš„èµ„æºã€‚</li>
</ul></section><section id="prerequisites" class="level3"><h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org">Rcpp</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªC++çš„ç¼–è¯‘ç¯å¢ƒï¼š</p>
<ul>
<li>Windowsï¼šå®‰è£…<a href="http://cran.r-project.org/bin/windows/Rtools/">Rtools</a>ã€‚</li>
<li>Macï¼šå®‰è£…Xcodeã€‚</li>
<li>Linuxï¼š<code>sudo apt-get install r-base-dev</code>
</li>
</ul></section></section><section id="getting-started-with-c" class="level2"><h2 class="anchored" data-anchor-id="getting-started-with-c">Getting started with C++</h2>
<p><code><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction()</a></code>å…è®¸ç›´æ¥åœ¨Rä¸­ç¼–å†™C++ä»£ç ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  int add(int x, int y, int z) {</span></span>
<span><span class="st">    int sum = x + y + z;</span></span>
<span><span class="st">    return sum;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  "</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># add works like a regular R function</span></span>
<span><span class="va">add</span></span>
<span><span class="co">#&gt; function (x, y, z) </span></span>
<span><span class="co">#&gt; .Call(&lt;pointer: 0x00007ffc68b115f0&gt;, x, y, z)</span></span>
<span><span class="fu">add</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œâ€œRcppâ€ä¼šç¼–è¯‘C++ä»£ç ï¼Œå¹¶å°†Rå‡½æ•°<code>add</code>ä¸C++å‡½æ•°<code>add</code>å…³è”èµ·æ¥ã€‚å…³è”è¿‡ç¨‹çš„å¤§é‡åº•å±‚ç»†èŠ‚è¢«â€œRcppâ€è‡ªè¡Œå¤„ç†äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ä¸åŒçš„ä¾‹å­ï¼Œç”±æµ…å…¥æ·±åœ°ä»‹ç»C++çš„è¯­æ³•ã€‚</p>
<section id="no-inputs-scalar-output" class="level3"><h3 class="anchored" data-anchor-id="no-inputs-scalar-output">No inputs, scalar output</h3>
<p>è®©æˆ‘ä»¬ä»¥ä¸€ä¸ªéå¸¸ç®€å•çš„å‡½æ•°å¼€å§‹â€”â€”æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œæ€»æ˜¯è¿”å›æ•´æ•°1ï¼š</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fl">1L</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ç­‰ä»·çš„C++å‡½æ•°ï¼š</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> one<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ä½¿ç”¨<code><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction()</a></code>å®ç°åœ¨Rä¸­ä½¿ç”¨è¿™ä¸ªC++å‡½æ•°ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  int one() {</span></span>
<span><span class="st">    return 1;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  "</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä¸Šé¢çš„ç¤ºä¾‹å±•ç¤ºäº†Rä¸C++ä¹‹é—´çš„ä¸€äº›ä¸»è¦åŒºåˆ«ï¼š</p>
<ul>
<li>åˆ›å»ºå‡½æ•°çš„è¯­æ³•ä¸è°ƒç”¨å‡½æ•°çš„è¯­æ³•ç±»ä¼¼ï¼›ä¸åƒåœ¨Rä¸­é‚£æ ·ä½¿ç”¨èµ‹å€¼æ¥åˆ›å»ºå‡½æ•°ã€‚</li>
<li>å¿…é¡»å£°æ˜å‡½æ•°è¿”å›ç»“æœçš„ç±»å‹ã€‚</li>
<li>æ ‡é‡ï¼ˆscalarï¼‰ä¸å‘é‡ï¼ˆvectorï¼‰ä¸åŒã€‚Rä¸­çš„æ•°å­—ã€æ•´æ•°ã€å­—ç¬¦ã€é€»è¾‘å‘é‡çš„å¯¹åº”ç¬¦å·æ˜¯ï¼š<code>NumericVector</code>ã€<code>IntegerVector</code>ã€<code>CharacterVector</code>ã€<code>LogicalVector</code>ã€‚æ ‡é‡çš„å¯¹åº”ç¬¦å·æ˜¯ï¼š<code>double</code>ã€<code>int</code>ã€<code>String</code>ã€<code>bool</code>ã€‚</li>
<li>å¿…é¡»æœ‰æ¸…æ™°çš„<code>return</code>å£°æ˜æ¥è¿”å›å€¼ã€‚</li>
<li>æ¯ä¸ªå£°æ˜å¿…é¡»ä»¥åˆ†å·<code>;</code>ç»“æŸã€‚</li>
</ul></section><section id="scalar-input-scalar-output" class="level3"><h3 class="anchored" data-anchor-id="scalar-input-scalar-output">Scalar input, scalar output</h3>
<p>ç¬¬äºŒä¸ªä¾‹å­æ˜¯<code><a href="https://rdrr.io/r/base/sign.html">sign()</a></code>å‡½æ•°çš„æ ‡é‡ç‰ˆæœ¬ï¼Œæ¥å—ä¸€ä¸ªæ ‡é‡è¾“å…¥ï¼Œå½“è¾“å…¥ä¸ºæ­£æ•°æ—¶è¿”å›1ï¼Œä¸º0æ—¶è¿”å›0ï¼Œä¸ºè´Ÿæ•°æ—¶è¿”å›-1ï¼š</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">signR</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fl">1</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fl">0</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="op">-</span><span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  int signC(int x) {</span></span>
<span><span class="st">    if (x &gt; 0) {</span></span>
<span><span class="st">      return 1;</span></span>
<span><span class="st">    } else if (x == 0) {</span></span>
<span><span class="st">      return 0;</span></span>
<span><span class="st">    } else {</span></span>
<span><span class="st">      return -1;</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">  }</span></span>
<span><span class="st"> "</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>C++ç‰ˆçš„å‡½æ•°ä¸­ï¼š</p>
<ul>
<li>å‡½æ•°çš„è¾“å…¥ä¸è¾“å‡ºä¸€æ ·ï¼Œä¹Ÿéœ€è¦å£°æ˜ç±»å‹ã€‚</li>
<li>
<code>if</code>è¯­å¥çš„è¯­æ³•ä¸€æ ·ï¼Œé€€å‡ºå¯ä»¥ä½¿ç”¨<code><a href="https://rdrr.io/r/base/Control.html">break</a></code>ï¼Œä½†æ˜¯è·³è¿‡éœ€è¦ä½¿ç”¨<code>continue</code>è€Œé<code><a href="https://rdrr.io/r/base/Control.html">next</a></code> ã€‚</li>
</ul></section><section id="vector-input-scalar-output" class="level3"><h3 class="anchored" data-anchor-id="vector-input-scalar-output">Vector input, scalar output</h3>
<p>Rä¸C++æœ‰ä¸€ä¸ªæ˜¾è‘—çš„ä¸åŒæ˜¯åœ¨forå¾ªç¯çš„èµ„æºæ¶ˆè€—ä¸Šï¼ŒC++æ›´ä½ã€‚ä¾‹å¦‚ï¼Œåœ¨forå¾ªç¯ä¸­æ‰§è¡Œ<code>sum</code>å‡½æ•°ï¼š</p>
<p>Rç‰ˆæœ¬ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sumR</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">total</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">total</span> <span class="op">&lt;-</span> <span class="va">total</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">total</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>C++ç‰ˆæœ¬ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  double sumC(NumericVector x) {</span></span>
<span><span class="st">    int n = x.size();</span></span>
<span><span class="st">    double total = 0;</span></span>
<span><span class="st">    for(int i = 0; i &lt; n; ++i) {</span></span>
<span><span class="st">      total += x[i];</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">    return total;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  "</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>C++ç‰ˆä¸Rç‰ˆæœ¬åœ¨ç»“æ„ä¸Šå¾ˆç›¸ä¼¼ï¼Œä½†ï¼š</p>
<ul>
<li><p>è·å–å‘é‡é•¿åº¦ï¼ŒC++é€šè¿‡<code>.size()</code>æ–¹æ³•å®Œæˆã€‚C++é€šè¿‡<code>.</code>æ¥è°ƒç”¨æ–¹æ³•ã€‚</p></li>
<li><p><code>for</code>çš„å£°æ˜è¯­æ³•ä¸ä¸€æ ·ï¼š<code>for(init; check; increment)</code>ã€‚é¢å¤–è®¾ç½®å˜é‡<code>i</code>ï¼Œåˆ¤æ–­<code>i</code>ä¸<code>n</code>çš„æ¯”è¾ƒã€‚</p></li>
<li><p>C++ä¸­ä½ç½®ç´¢å¼•çš„èµ·å§‹æ˜¯0ã€‚</p></li>
<li><p>ä½¿ç”¨<code>=</code>èµ‹å€¼ï¼Œè€Œä¸æ˜¯<code>&lt;-</code>ã€‚</p></li>
<li><p>C++æä¾›åŸä½ä¿®æ”¹è¿ç®—ç¬¦ï¼š<code>total += x[i]</code>ã€‚é™¤æ­¤è¿˜æœ‰<code>-=</code>ã€<code>*=</code>ã€<code>/=</code>ã€‚</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e3</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  <span class="fu">sumC</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  <span class="fu">sumR</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 3 Ã— 6</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 sum(x)        700ns    800ns  1145751.        0B        0</span></span>
<span><span class="co">#&gt; 2 sumC(x)       1.6Âµs    1.7Âµs   531629.        0B        0</span></span>
<span><span class="co">#&gt; 3 sumR(x)      21.8Âµs   22.1Âµs    42750.      18KB        0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="vector-input-vector-output" class="level3"><h3 class="anchored" data-anchor-id="vector-input-vector-output">Vector input, vector output</h3>
<p>ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè®¡ç®—å•ä¸ªå€¼ä¸å‘é‡çš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼š</p>
<p>Rç‰ˆæœ¬ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pdistR</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">ys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">ys</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åœ¨Rä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨å‡½æ•°ä¸­å®šä¹‰<code>x</code>æ˜¯æ ‡é‡ï¼Œè€Œæ˜¯åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜è¿™ä¸€ç‚¹ã€‚åœ¨C++ç‰ˆæœ¬ä¸­ï¼Œåˆ™å¿…é¡»æ˜ç¡®è¯´æ˜ç±»å‹ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  NumericVector pdistC(double x, NumericVector ys) {</span></span>
<span><span class="st">    int n = ys.size();</span></span>
<span><span class="st">    NumericVector out(n);</span></span>
<span><span class="st"></span></span>
<span><span class="st">    for(int i = 0; i &lt; n; ++i) {</span></span>
<span><span class="st">      out[i] = sqrt(pow(ys[i] - x, 2.0));</span></span>
<span><span class="st">    }</span></span>
<span><span class="st"></span></span>
<span><span class="st">    return out;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  "</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>è¿™ä¸ªC++å‡½æ•°å¼•å…¥äº†ä¸€äº›æ–°æ¦‚å¿µï¼š</p>
<ul>
<li><p>åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º<code>n</code>çš„æ•°å­—å‘é‡éœ€è¦æ„é€ å™¨ï¼š<code>NumericVector out(n)</code>ã€‚æ‹·è´ä¸€ä¸ªéœ€è¦ï¼š<code>NumericVector zs = clone(ys)</code>ã€‚</p></li>
<li><p>ä½¿ç”¨<code>pow()</code>è€Œé<code>^</code>è®¡ç®—å¹‚ã€‚</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="fu">pdistR</span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  <span class="fu">pdistC</span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 Ã— 6</span></span>
<span><span class="co">#&gt;   expression          min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt;     &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 pdistR(0.5, y)   5.88ms   6.29ms      156.    7.63MB     81.6</span></span>
<span><span class="co">#&gt; 2 pdistC(0.5, y)   3.39ms   3.89ms      245.    7.63MB    122.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä¸Šé¢çš„ç»“æœæ˜¾ç¤ºï¼ŒC++å¹¶æ²¡æœ‰æ¯”Rå¿«å¤šå°‘ï¼ŒèŠ‚çº¦çš„æ—¶é—´ä¸å¼€å‘C++å‡½æ•°çš„æ—¶é—´ç›¸æ¯”ä¸å€¼ä¸€æã€‚è€Œä¸”C++è¿è¡Œå¿«é€Ÿçš„çœŸæ­£åŸå› æ˜¯å®ƒåªæ˜¯ç”¨äº†é›¶æ—¶æ ‡é‡<code>ys[i] -x</code>ï¼Œè€ŒRä½¿ç”¨äº†ä¸´æ—¶å‘é‡<code>x - ys</code>ï¼Œé¢å¤–åˆ†é…çš„å†…å­˜ä¼šå ç”¨å¤§é‡æ—¶é—´ã€‚</p>
</section><section id="using-sourcecpp" class="level3"><h3 class="anchored" data-anchor-id="using-sourcecpp">Using sourceCpp</h3>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦ä½¿ç”¨<code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp()</a></code>æ¥å•ç‹¬åŠ è½½C++è„šæœ¬ã€‚åœ¨ä½¿ç”¨æ”¯æŒC++çš„IDEç¼–å†™è„šæœ¬å¯ä»¥æä¾›è¯­æ³•é«˜äº®ï¼Œè‡ªåŠ¨è¡¥é½ï¼Œè¯­æ³•æ£€æŸ¥ç­‰åŠŸèƒ½ã€‚</p>
<p>ç‹¬ç«‹çš„C++è„šæœ¬éœ€è¦åŠ è½½<code>.cpp</code>æ’ä»¶ï¼š</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>åŒæ—¶æ¯ä¸ªå‡½æ•°å‰éœ€è¦å£°æ˜<code>// [[Rcpp::export]]</code>æ‰å¯ä»¥è¢«Rè°ƒç”¨ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥åœ¨C++æ³¨é‡Šå—ä¸­æ’å…¥Rä»£ç ï¼Œåœ¨æµ‹è¯•æ—¶ï¼Œä¼šè¢«æ‰§è¡Œå¹¶åœ¨Rç»ˆç«¯è¾“å‡ºç»“æœï¼ˆå› ä¸º<code>source(echo = TRUE)</code>ï¼‰ï¼š</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*** R</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This is R code</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>è¿è¡Œ<code>sourceCpp("path/to/file.cpp")</code>ä¼šåˆ›å»ºå¯¹åº”çš„Rå‡½æ•°ï¼Œå¹¶åŠ è½½åˆ°å½“å‰ç¯å¢ƒã€‚éœ€è¦æ³¨æ„ï¼šè¿™äº›å‡½æ•°æ— æ³•è¢«ä¿å­˜åœ¨<code>.Rdata</code>æ–‡ä»¶ä¸­ï¼Œæ¯æ¬¡å¯åŠ¨Réƒ½éœ€è¦é‡æ–°åˆ›å»ºã€‚</p>
<p>ä¾‹å¦‚ï¼Œè¿è¡Œ<code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp()</a></code>åŠ è½½ä¸‹é¢çš„è„šæœ¬ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º<code>meanC</code>çš„å‡½æ•°ï¼Œå¹¶åŠ è½½åˆ°å½“å‰ç¯å¢ƒï¼š</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> meanC<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> total <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    total <span class="op">+=</span> x<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">/*** R</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">x &lt;- runif(1e5)</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">bench::mark(</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">  mean(x),</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">  meanC(x)</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>åœ¨Rmarkdownä¸­ï¼Œå¯ä»¥è®¾ç½®<code>{r, engine = "Rcpp"}</code>è¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥åç»­çš„C++å‡½æ•°å®šä¹‰éƒ½å•ç‹¬æ”¾åœ¨ä¸€ä¸ªä»£ç å—ä¸­ï¼Œæ­¤æ—¶ä¸èƒ½æ·»åŠ æ³¨é‡Šäº†å“¦ã€‚</p>
</section></section><section id="other-classes" class="level2"><h2 class="anchored" data-anchor-id="other-classes">Other classes</h2>
<p>å‰é¢ä»‹ç»äº†â€œRcppâ€æ”¯æŒçš„åŸºç¡€å‘é‡ç±»å‹ï¼š<code>NumericVector</code>ã€<code>IntegerVector</code>ã€<code>CharacterVector</code>ã€<code>LogicalVector</code>ï¼ŒåŸºç¡€æ ‡é‡ç±»å‹ï¼š<code>double</code>ã€<code>int</code>ã€<code>String</code>ã€<code>bool</code>ã€‚â€œRcppâ€ä¹Ÿæ”¯æŒå…¶ä»–æ•°æ®ç±»å‹ï¼Œé‡è¦çš„å¦‚ï¼Œlistï¼Œdataframeï¼Œfunctionï¼Œattributeã€‚åŒæ—¶å®ƒä¹Ÿå¯¹å¾ˆå¤šç±»æä¾›æ”¯æŒå¦‚ï¼Œ<code>Environment</code>ï¼Œ<code>DottedPair</code>ï¼Œ<code>Language</code>ï¼Œ<code>Symbol</code>ç­‰ï¼Œä½†è¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ã€‚ï¼ˆæ‰€è°“çš„â€œæ”¯æŒâ€å°±æ˜¯è¯´ï¼ŒC++ä»£ç å¯ä»¥è®¿é—®Rå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªRå¯¹è±¡ã€‚ï¼‰</p>
<section id="lists-and-data-frames" class="level3"><h3 class="anchored" data-anchor-id="lists-and-data-frames">Lists and data frames</h3>
<p>â€œRcppâ€æä¾›äº†å¯¹listå’Œdata frameçš„æ”¯æŒï¼Œä½†å®ƒä»¬å¸¸ç”¨æ¥ä½œä¸ºè¾“å‡ºä½¿ç”¨ï¼Œè€Œéè¾“å…¥ã€‚è¿™æ˜¯å› ä¸ºå®ƒä»¬å¯ä»¥æœ‰ä»»æ„çš„é™„åŠ å±æ€§ï¼Œå½“ä½œä¸ºè¾“å…¥æ—¶ï¼ŒC++éœ€è¦æå‰çŸ¥é“è¿™äº›å±æ€§ã€‚å¦‚æœ list çš„ç»“æ„å·²çŸ¥ä¸”å›ºå®šï¼ŒC++å¯ä»¥æå–å®ƒçš„å…ƒç´ å¹¶ä½¿ç”¨<code>as()</code>å°†å…¶è½¬æ¢ä¸ºå…¶ä»–ç±»å‹ã€‚ä¾‹å¦‚ï¼š<code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>ç”Ÿæˆçš„ç»“æœåŒ…å«çš„å†…å®¹æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä»ç»“æœä¸­æŠ½å–å¯¹åº”çš„å…ƒç´ è®¡ç®—â€œå¹³å‡ç™¾åˆ†æ¯”è¯¯å·®â€ï¼ˆ<code>mpe()</code>ï¼‰ã€‚</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> mpe<span class="op">(</span>List mod<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>mod<span class="op">.</span>inherits<span class="op">(</span><span class="st">"lm"</span><span class="op">))</span> stop<span class="op">(</span><span class="st">"Input must be a linear model"</span><span class="op">);</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  NumericVector resid <span class="op">=</span> as<span class="op">&lt;</span>NumericVector<span class="op">&gt;(</span>mod<span class="op">[</span><span class="st">"residuals"</span><span class="op">]);</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  NumericVector fitted <span class="op">=</span> as<span class="op">&lt;</span>NumericVector<span class="op">&gt;(</span>mod<span class="op">[</span><span class="st">"fitted.values"</span><span class="op">]);</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> resid<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> err <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    err <span class="op">+=</span> resid<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> <span class="op">(</span>fitted<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> resid<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> err <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>æ³¨æ„ï¼šä½¿ç”¨<code>.inherits()</code>æ£€æŸ¥å¯¹è±¡ç±»å‹æ˜¯å¦çœŸçš„æ˜¯â€œlmâ€ã€‚</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu">mpe</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -0.01541615</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="functions" class="level3"><h3 class="anchored" data-anchor-id="functions">Functions</h3>
<p>C++å¯ä»¥ä½¿ç”¨<code>Function</code>ç±»ç›´æ¥è®¿é—®Rå‡½æ•°ï¼Œä½†æ˜¯å› ä¸ºè¾“å‡ºçš„ç»“æœç±»å‹ä¸ç¡®å®šï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>RObject</code>ç±»ã€‚</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>RObject callWithOne<span class="op">(</span>Function f<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">callWithOne</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu">callWithOne</span><span class="op">(</span><span class="va">paste</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å½“å‡½æ•°<code>f</code>ä½¿ç”¨ä½ç½®ç´¢å¼•è·å–å‚æ•°æ—¶ï¼š</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>f<span class="op">(</span><span class="st">"y"</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ä½¿ç”¨å¸¦æœ‰åç§°çš„å‚æ•°ï¼š</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>f<span class="op">(</span>_<span class="op">[</span><span class="st">"x"</span><span class="op">]</span> <span class="op">=</span> <span class="st">"y"</span><span class="op">,</span> _<span class="op">[</span><span class="st">"value"</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="attributes" class="level3"><h3 class="anchored" data-anchor-id="attributes">Attributes</h3>
<p>C++å¯ä»¥ä½¿ç”¨<code>.attr()</code>è®¿é—®Rå¯¹è±¡çš„å±æ€§ã€‚<code>.names()</code>å¯ä»¥ç›´æ¥è·å–nameå±æ€§ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ³¨æ„å¯ä»¥ä½¿ç”¨ç±»æ–¹æ³•<code>::create()</code>ç”±C++æ ‡é‡åˆ›å»ºRå‘é‡ã€‚</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>NumericVector attribs<span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  NumericVector out <span class="op">=</span> NumericVector<span class="op">::</span>create<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  out<span class="op">.</span>names<span class="op">()</span> <span class="op">=</span> CharacterVector<span class="op">::</span>create<span class="op">(</span><span class="st">"a"</span><span class="op">,</span> <span class="st">"b"</span><span class="op">,</span> <span class="st">"c"</span><span class="op">);</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  out<span class="op">.</span>attr<span class="op">(</span><span class="st">"my-attr"</span><span class="op">)</span> <span class="op">=</span> <span class="st">"my-value"</span><span class="op">;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  out<span class="op">.</span>attr<span class="op">(</span><span class="st">"class"</span><span class="op">)</span> <span class="op">=</span> <span class="st">"my-class"</span><span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å¯¹äºS4å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨<code>.slot()</code>ã€‚</p>
</section></section><section id="missing-values" class="level2"><h2 class="anchored" data-anchor-id="missing-values">Missing values</h2>
<p>å¦‚æœä½ æƒ³ä½¿ç”¨ç¼ºå¤±å€¼ï¼Œä½ éœ€è¦çŸ¥é“ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>C++çš„æ ‡é‡ç±»å‹å¦‚ä½•å¤„ç†ç¼ºå¤±å€¼ã€‚</li>
<li>C++çš„å‘é‡ç±»å‹å¦‚ä½•è·å–å’Œè®¾ç½®ç¼ºå¤±å€¼ã€‚</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>æ³¨æ„ï¼šä¸‹é¢å¯¹æ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œæœ‰äº›æ˜¯C++åŸç”Ÿç±»å‹ï¼Œæœ‰äº›æ˜¯Rcppè‡ªå®šä¹‰ã€‚Rcppå®šä¹‰çš„ç±»å‹å¯ä»¥å®Œç¾åœ°é€‚é…ç¼ºå¤±å€¼ã€‚</p>
</div>
</div>
<section id="scalars" class="level3"><h3 class="anchored" data-anchor-id="scalars">Scalars</h3>
<p>ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†ï¼šå°†Rçš„ç¼ºå¤±å€¼è½¬æ¢ä¸ºC++æ ‡é‡ï¼Œç„¶åå†è½¬å›ä¸ºRå‘é‡ã€‚è¿™æ˜¯ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬å¼„æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>List scalar_missings<span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> int_s <span class="op">=</span> NA_INTEGER<span class="op">;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  String chr_s <span class="op">=</span> NA_STRING<span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> lgl_s <span class="op">=</span> NA_LOGICAL<span class="op">;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> num_s <span class="op">=</span> NA_REAL<span class="op">;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> List<span class="op">::</span>create<span class="op">(</span>int_s<span class="op">,</span> chr_s<span class="op">,</span> lgl_s<span class="op">,</span> num_s<span class="op">);</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu">scalar_missings</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ : int NA</span></span>
<span><span class="co">#&gt;  $ : chr NA</span></span>
<span><span class="co">#&gt;  $ : logi TRUE</span></span>
<span><span class="co">#&gt;  $ : num NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä»ç»“æœæ¥çœ‹ï¼Œé™¤äº†<code>bool</code>ï¼Œå…¶ä»–ç±»å‹çš„ç¼ºå¤±å€¼éƒ½æ­£å¸¸ã€‚å®é™…ä¸Šï¼Œäº‹æƒ…å¹¶ä¸æ˜¯å¦‚æ­¤ç®€å•ã€‚</p>
<section id="integers" class="level4"><h4 class="anchored" data-anchor-id="integers">Integers</h4>
<p>åœ¨C++ä¸­ï¼Œæ•´æ•°ç¼ºå¤±å€¼è¢«å‚¨å­˜ä¸ºæœ€å°æ•´æ•°ã€‚å¦‚æœä½ ä¸å¯¹å®ƒåšä»»ä½•å¤„ç†ï¼Œå®ƒä¼šæ˜¾å¾—å¾ˆæ­£å¸¸ã€‚å¦‚æœä½ å¯¹å®ƒåšäº†ä¸€äº›å¤„ç†ï¼Œå¦‚<code>NA_INTEGER + 1</code>ï¼Œå› ä¸ºC++å¹¶ä¸çŸ¥é“æœ€å°æ•´æ•°åœ¨æ­¤å¤„ä»£è¡¨ç¼ºå¤±å€¼ï¼Œå®ƒä¼šè¿›è¡Œè®¡ç®—è¿”å›å€¼ã€‚</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NA_INTEGER + 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -2147483647</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å¦‚æœä½ æƒ³åº”ç”¨æ•´æ•°ç¼ºå¤±å€¼ï¼Œå¯ä»¥ä½¿ç”¨é•¿åº¦ä¸º1çš„<code>IntegerVector</code>æˆ–ä»”ç»†æ§åˆ¶ä»£ç å¯¹ç¼ºå¤±å€¼çš„å¤„ç†ã€‚</p>
</section><section id="doubles" class="level4"><h4 class="anchored" data-anchor-id="doubles">Doubles</h4>
<p>å¯¹äºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä½ æˆ–è®¸å¯ä»¥ä¸ç”¨ç†ä¼šç¼ºå¤±å€¼ï¼Œç›´æ¥å¤„ç†NaNï¼ˆéæ•°å­—ï¼‰ã€‚è¿™æ˜¯å› ä¸ºRè¯­è¨€ä¸­çš„NAæ˜¯ IEEE 754 æµ®ç‚¹æ•° NaN çš„ä¸€ç§ç‰¹æ®Šç±»å‹ã€‚å› æ­¤ï¼Œä»»ä½•æ¶‰åŠNaNï¼ˆåœ¨ C++ ä¸­ä¸º NANï¼‰çš„é€»è¾‘è¡¨è¾¾å¼çš„æ±‚å€¼ç»“æœéƒ½å§‹ç»ˆä¸º FALSEï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN == 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN &lt; 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN &gt; 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN == NAN"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä»»ä½•æ•°å­—ä¸NaNcyè¿›è¡Œè®¡ç®—éƒ½ä¼šäº§ç”ŸNaNï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN + 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NaN</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN - 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NaN</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN / 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NaN</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN * 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NaN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä½†æ˜¯ä¸å¸ƒå°”å€¼è®¡ç®—æ—¶è¦å°å¿ƒï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN &amp;&amp; TRUE"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html">evalCpp</a></span><span class="op">(</span><span class="st">"NAN || FALSE"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="strings" class="level4"><h4 class="anchored" data-anchor-id="strings">Strings</h4>
<p><code>String</code>ç”±â€œRcppâ€å®šä¹‰ï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç†ç¼ºå¤±å€¼ã€‚</p>
</section><section id="boolean" class="level4"><h4 class="anchored" data-anchor-id="boolean">Boolean</h4>
<p>C++ä¸­çš„<code>bool</code>ç±»å‹åªæœ‰<code>true</code>å’Œ<code>false</code>ï¼Œè€ŒRè¯­è¨€ä¸­çš„<code>logical</code>ç±»å‹æœ‰<code>TRUE</code>ã€<code>FALSE</code>å’Œ<code>NA</code>ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>int</code>ç±»å‹æ¥å®ç°ç¼ºå¤±å€¼ï¼ˆ<code>NA_INTEGER</code>ï¼‰ã€‚å¦‚æœä½ è¦å°†ä¸€ä¸ªé•¿åº¦ä¸º1çš„R-logicalå‘é‡è½¬æ¢ä¸ºC++çš„<code>bool</code>ï¼Œéœ€è¦æ³¨æ„ç¼ºå¤±å€¼ï¼Œå› ä¸ºå®ƒä¼šè¢«è½¬æ¢ä¸º<code>true</code>ã€‚</p>
</section></section><section id="vectors" class="level3"><h3 class="anchored" data-anchor-id="vectors">Vectors</h3>
<p>å¯¹äºå‘é‡ï¼Œâ€œRcppâ€æœ‰å®šä¹‰å¥½çš„ç¼ºå¤±å€¼ç±»å‹ï¼š<code>NA_REAL</code>ã€<code>NA_INTEGER</code>ã€<code>NA_STRING</code>ã€<code>NA_LOGICAL</code>ã€‚</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>List missing_sampler<span class="op">()</span> <span class="op">{</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> List<span class="op">::</span>create<span class="op">(</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    NumericVector<span class="op">::</span>create<span class="op">(</span>NA_REAL<span class="op">),</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    IntegerVector<span class="op">::</span>create<span class="op">(</span>NA_INTEGER<span class="op">),</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    LogicalVector<span class="op">::</span>create<span class="op">(</span>NA_LOGICAL<span class="op">),</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    CharacterVector<span class="op">::</span>create<span class="op">(</span>NA_STRING<span class="op">)</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu">missing_sampler</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ : num NA</span></span>
<span><span class="co">#&gt;  $ : int NA</span></span>
<span><span class="co">#&gt;  $ : logi NA</span></span>
<span><span class="co">#&gt;  $ : chr NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="standard-template-library" class="level2"><h2 class="anchored" data-anchor-id="standard-template-library">Standard Template Library</h2>
<p>C++çœŸå®çš„ä¼˜åŠ¿ä½“ç°åœ¨å®ƒçš„æ ‡å‡†æ¨¡æ¿åº“ä¸Šï¼Œå½“ä½ éœ€è¦æ‰§è¡Œå¤æ‚ç®—æ³•æ—¶ï¼ŒSTLæä¾›äº†ä¸€å¥—æå…¶æœ‰ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚æœ¬èŠ‚å°†è§£é‡Šä¸€äº›æœ€é‡è¦çš„ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå¹¶ä¸ºæŒ‡æ˜æ­£ç¡®çš„å­¦ä¹ æ–¹å‘ï¼Œå¸Œæœ›è¿™äº›ç¤ºä¾‹èƒ½å‘ä½ å±•ç¤ºSTLçš„å¼ºå¤§åŠŸèƒ½ï¼Œå¹¶è¯´æœä½ ç›¸ä¿¡å­¦ä¹ æ›´å¤šçŸ¥è¯†æ˜¯æœ‰ç”¨çš„ã€‚</p>
<p>å¦‚æœä½ éœ€è¦çš„æŸä¸ªæ•°æ®ç»“æ„æˆ–ç®—æ³•ä¸åœ¨STLä¸­ï¼Œä½ å¯ä»¥åœ¨<a href="https://www.boost.org/libraries/latest/grid/">boost</a>ä¸­æ‰¾æ‰¾ã€‚ä¸€æ—¦ä½ åœ¨ç”µè„‘ä¸Šå®‰è£…äº†boostï¼Œä½ å¯ä»¥åœ¨å¤´æ–‡ä»¶ä¸­å†™ä¸‹<code>#include &lt;boost/test.hpp&gt;</code>æ¥ä½¿ç”¨boostä¸­çš„ç®—æ³•ã€‚</p>
<section id="using-iterators" class="level3"><h3 class="anchored" data-anchor-id="using-iterators">Using iterators</h3>
<p>è¿­ä»£å™¨ï¼ˆiteratorï¼‰åœ¨STLä¸­åº”ç”¨å¹¿æ³›ï¼Œè®¸å¤šå‡½æ•°æ¥å—æˆ–è¿”å›è¿­ä»£å™¨ã€‚å®ƒä»¬æ—¶åŸºç¡€for-loopçš„å‡çº§ï¼ŒæŠ½è±¡å‡ºåº•å±‚æ•°æ®ç»“æ„çš„ç»†èŠ‚ã€‚è¿­ä»£å™¨æœ‰ä¸‰ä¸ªä¸»è¦æ“ä½œç¬¦ï¼š</p>
<ul>
<li>
<code>*</code>ï¼šè¿”å›è¿­ä»£å™¨æŒ‡å‘çš„å…ƒç´ ã€‚</li>
<li>
<code>++</code>ï¼šå°†è¿­ä»£å™¨æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li>
<code>==</code>ï¼šæ¯”è¾ƒä¸¤ä¸ªè¿­ä»£å™¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå…ƒç´ ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿­ä»£å™¨é‡å†™â€œsumâ€å‡½æ•°ï¼š</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> sum3<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> total <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  NumericVector<span class="op">::</span>iterator it<span class="op">;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span>it <span class="op">=</span> x<span class="op">.</span>begin<span class="op">();</span> it <span class="op">!=</span> x<span class="op">.</span>end<span class="op">();</span> <span class="op">++</span>it<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    total <span class="op">+=</span> <span class="op">*</span>it<span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ç›¸è¾ƒäºfor-loopï¼Œè¿­ä»£å™¨çš„ä¸»è¦æ”¹å˜æœ‰ï¼š</p>
<ul>
<li><p>å¾ªç¯å¼€å§‹äº<code>x.begin()</code>ï¼Œç»“æŸäº<code>x.end()</code>ã€‚è¿­ä»£å™¨ä½¿ç”¨<code>x.end</code>å‚¨å­˜äº†å¾ªç¯çš„æœ«å°¾å€¼ï¼Œå‡å°‘äº†æ¯æ¬¡è¿­ä»£æ—¶è¿›è¡ŒæŸ¥è¯¢æœ«å°¾å€¼çš„å·¥ä½œã€‚</p></li>
<li><p>ä½¿ç”¨è§£å¼•ç¬¦<code>*</code>è·å–è¿­ä»£å™¨æŒ‡å‘çš„å…ƒç´ ã€‚</p></li>
<li><p>æ¯ç§æ•°æ®ç±»å‹æœ‰å®ƒè‡ªå·±çš„è¿­ä»£å™¨ï¼š<code>NumericVector::iterator</code>ã€<code>IntegerVector::iterator</code>ã€<code>LogicalVector::iterator</code>ã€<code>CharacterVector::iterator</code>ã€‚</p></li>
</ul>
<p>ä¸Šé¢çš„ä»£ç å¯ä»¥ä½¿ç”¨C++11çš„range-based for-loopé‡å†™ï¼ŒRcppä½¿ç”¨<code>[[Rcpp::plugins(cpp11)]]</code>æ¿€æ´»ï¼š</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp11)]]</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> sum4<span class="op">(</span>NumericVector xs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> total <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="at">const</span> <span class="kw">auto</span> <span class="op">&amp;</span>x <span class="op">:</span> xs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    total <span class="op">+=</span> x<span class="op">;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>è¿­ä»£å™¨ä¹Ÿå…è®¸æˆ‘ä»¬ä½¿ç”¨C++ä¸­ç›¸å½“äºapplyçš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>accumulate()</code>å‡½æ•°å†æ¬¡é‡å†™<code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªèµ·å§‹è¿­ä»£å™¨å’Œä¸€ä¸ªç»“æŸè¿­ä»£å™¨ï¼Œå¹¶å°†<code>vector</code>ä¸­çš„æ‰€æœ‰å€¼ç›¸åŠ ã€‚<code>accumulate()</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°ç»™å‡ºäº†åˆå§‹å€¼ï¼šå®ƒç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºå®ƒå†³å®šäº†<code>accumulate()</code>ä½¿ç”¨çš„æ•°æ®ç±»å‹ï¼ˆä½¿ç”¨<code>0.0</code>è¡¨ç¤º<code>accumulate()</code>ä½¿ç”¨çš„æ˜¯<code>double</code>ï¼Œä½¿ç”¨<code>0</code>è¡¨ç¤º<code>int</code>ï¼‰ã€‚è¦ä½¿ç”¨<code>accumulate()</code>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¤´æ–‡ä»¶ä¸­å¼•å…¥<code>&lt;Numeric&gt;</code>ã€‚</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> sum5<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>accumulate<span class="op">(</span>x<span class="op">.</span>begin<span class="op">(),</span> x<span class="op">.</span>end<span class="op">(),</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="algorithms" class="level3"><h3 class="anchored" data-anchor-id="algorithms">Algorithms</h3>
<p>å¤´æ–‡ä»¶<code>&lt;algorithm&gt;</code>æä¾›äº†å¤§é‡äºä½¿ç”¨è¿­ä»£å™¨çš„ç®—æ³•ï¼Œä½ å¯ä»¥å‚è€ƒ<a href="https://en.cppreference.com/w/cpp/algorithm">en.cppreference.com</a>ã€‚</p>
<p><code><a href="https://rdrr.io/r/base/findInterval.html">findInterval()</a></code>å‡½æ•°æ¥å—ä¸€ä¸ªå‘é‡å’Œä¸€ä¸ªåŒºé—´å‘é‡ï¼Œè¿”å›ä¸€ä¸ªå‘é‡ï¼Œè¯¥å‘é‡åŒ…å«æ¯ä¸ªå…ƒç´ åœ¨åŒºé—´å‘é‡ä¸­çš„ç´¢å¼•ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">:</span><span class="fl">18</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span> <span class="co"># create two bins [5,10) and [10,15)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        x  </span></span>
<span><span class="co">#&gt;  [1,]  2 0</span></span>
<span><span class="co">#&gt;  [2,]  3 0</span></span>
<span><span class="co">#&gt;  [3,]  4 0</span></span>
<span><span class="co">#&gt;  [4,]  5 1</span></span>
<span><span class="co">#&gt;  [5,]  6 1</span></span>
<span><span class="co">#&gt;  [6,]  7 1</span></span>
<span><span class="co">#&gt;  [7,]  8 1</span></span>
<span><span class="co">#&gt;  [8,]  9 1</span></span>
<span><span class="co">#&gt;  [9,] 10 2</span></span>
<span><span class="co">#&gt; [10,] 11 2</span></span>
<span><span class="co">#&gt; [11,] 12 2</span></span>
<span><span class="co">#&gt; [12,] 13 2</span></span>
<span><span class="co">#&gt; [13,] 14 2</span></span>
<span><span class="co">#&gt; [14,] 15 3</span></span>
<span><span class="co">#&gt; [15,] 16 3</span></span>
<span><span class="co">#&gt; [16,] 17 3</span></span>
<span><span class="co">#&gt; [17,] 18 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä¸‹é¢æ˜¯Rcppç‰ˆçš„åŸºç¡€å®ç°ï¼š</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>IntegerVector findInterval2<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector breaks<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  IntegerVector out<span class="op">(</span>x<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  NumericVector<span class="op">::</span>iterator it<span class="op">,</span> pos<span class="op">;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  IntegerVector<span class="op">::</span>iterator out_it<span class="op">;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span>it <span class="op">=</span> x<span class="op">.</span>begin<span class="op">(),</span> out_it <span class="op">=</span> out<span class="op">.</span>begin<span class="op">();</span> it <span class="op">!=</span> x<span class="op">.</span>end<span class="op">();</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">++</span>it<span class="op">,</span> <span class="op">++</span>out_it<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> <span class="bu">std::</span>upper_bound<span class="op">(</span>breaks<span class="op">.</span>begin<span class="op">(),</span> breaks<span class="op">.</span>end<span class="op">(),</span> <span class="op">*</span>it<span class="op">);</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>out_it <span class="op">=</span> <span class="bu">std::</span>distance<span class="op">(</span>breaks<span class="op">.</span>begin<span class="op">(),</span> pos<span class="op">);</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>å…³é”®ç‚¹ï¼š</p>
<ul>
<li><p>åŒæ—¶è¾“å…¥ä¸¤ä¸ªè¿­ä»£å™¨ï¼Œ<code>it</code>å’Œ<code>out_it</code>ã€‚</p></li>
<li><p>ä½¿ç”¨<code>*out_it</code>æ¥ä¿®æ”¹<code>out</code>çš„å€¼ã€‚</p></li>
<li><p><code>upper_bound()</code>è¿”å›è¿­ä»£å™¨<code>pos</code>ï¼Œç„¶åä½¿ç”¨<code>std::distance()</code>æ‰¾åˆ°å®ƒåœ¨<code>breaks</code>ä¸­çš„ç´¢å¼•ã€‚</p></li>
<li><p>tipsï¼šRä¸­çš„<code><a href="https://rdrr.io/r/base/findInterval.html">findInterval()</a></code>å·²ç»æ˜¯ä½¿ç”¨Cå®ç°çš„ã€‚å¦‚æœæƒ³ä¸Šé¢çš„å‡½æ•°å’ŒRä¸­çš„ä¸€æ ·å¿«ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—ä¸€æ¬¡å¯¹<code>.begin()</code>å’Œ<code>.end()</code>çš„è°ƒç”¨ï¼Œå¹¶ä¿å­˜ç»“æœã€‚è¿™æ ·åšä¼šåˆ†æ•£æˆ‘ä»¬çš„æ³¨æ„åŠ›ï¼Œæ‰€ä»¥å¿½ç•¥äº†è¿™ä¸ªä¼˜åŒ–ã€‚æ·»åŠ è¿™ä¸€æ­¥éª¤å¯ä»¥ç”Ÿæˆæ¯”Rçš„<code><a href="https://rdrr.io/r/base/findInterval.html">findInterval()</a></code>æ›´å¿«çš„ä»£ç ï¼Œä½†æ˜¯ä»£ç é‡æ›´å°‘ï¼Œå¤§çº¦æ˜¯Råº•å±‚çš„1/10ã€‚</p></li>
</ul>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨ST ä¸­çš„ç®—æ³•æ¯”ä½¿ç”¨æ‰‹åŠ¨å¾ªç¯æ›´å¥½ã€‚åœ¨ã€ŠEffective STLã€‹ä¸€ä¹¦ä¸­ï¼ŒScott Meyers ç»™å‡ºäº†ä¸‰ä¸ªåŸå› ï¼šæ•ˆç‡ã€æ­£ç¡®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚STLä¸­çš„ç®—æ³•ç”±C++ä¸“å®¶ç¼–å†™ï¼Œéå¸¸é«˜æ•ˆï¼Œè€Œä¸”å®ƒä»¬å·²ç»å­˜åœ¨äº†å¾ˆé•¿æ—¶é—´ï¼Œå¹¶ä¸”ç»è¿‡äº†å……åˆ†çš„æµ‹è¯•ã€‚ä½¿ç”¨æ ‡å‡†ç®—æ³•è¿˜èƒ½ä½¿ä»£ç çš„æ„å›¾æ›´åŠ æ˜ç¡®ï¼Œæœ‰åŠ©äºä½¿å…¶æ›´åŠ å¯è¯»å’Œå¯ç»´æŠ¤ã€‚</p>
</section><section id="data-structures" class="level3"><h3 class="anchored" data-anchor-id="data-structures">Data structures</h3>
<p>STLæä¾›äº†å¤§é‡æ•°æ®ç»“æ„ï¼š<code>array</code>,&nbsp;<code>bitset</code>,&nbsp;<code>list</code>,&nbsp;<code>forward_list</code>,&nbsp;<code>map</code>,&nbsp;<code>multimap</code>,&nbsp;<code>multiset</code>,&nbsp;<code>priority_queue</code>,&nbsp;<code>queue</code>,&nbsp;<code>deque</code>,&nbsp;<code>set</code>,&nbsp;<code>stack</code>,&nbsp;<code>unordered_map</code>,&nbsp;<code>unordered_set</code>,&nbsp;<code>unordered_multimap</code>,&nbsp;<code>unordered_multiset</code>, <code>vector</code>. å…¶ä¸­æœ€é‡è¦çš„æ˜¯ï¼š<code>vector</code>, <code>unordered_set</code>,&nbsp;<code>unordered_map</code>ã€‚æœ¬èŠ‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»è¿™ä¸‰ç§æ•°æ®ç»“æ„ï¼Œå…¶ä»–æ•°æ®ç»“æ„çš„ä½¿ç”¨æ–¹æ³•ç›¸ä¼¼ï¼Œåªæ˜¯æ€§èƒ½ç•¥æœ‰ä¸åŒã€‚ä½ å¯ä»¥å‚è€ƒ<a href="https://en.cppreference.com/w/cpp/container">en.cppreference.com</a>ã€‚</p>
<p>RcppçŸ¥é“å¦‚ä½•å°†è®¸å¤šSTLæ•°æ®ç»“æ„è½¬æ¢ä¸ºRç­‰ä»·ç‰©ï¼Œå› æ­¤ä½ å¯ä»¥ä»å‡½æ•°ä¸­è¿”å›å®ƒä»¬ï¼Œè€Œæ— éœ€æ˜¾å¼è½¬æ¢ä¸ºRæ•°æ®ç»“æ„ã€‚</p>
<section id="vectors-1" class="level4"><h4 class="anchored" data-anchor-id="vectors-1">Vectors</h4>
<p>STL vector ä¸Rä¸­çš„vector ç±»ä¼¼ï¼Œä½†å®ƒèƒ½é«˜æ•ˆæ‰©å®¹ï¼Œé€‚åˆåœ¨ä½ ä¸çŸ¥é“è¾“å‡ºå‘é‡çš„å¤§å°æ—¶ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvectoræ˜¯æ¨¡æ¿åŒ–çš„ï¼Œä½ éœ€è¦åŒ…å«ä¸åŒå…ƒç´ çš„å‘é‡è¿›è¡Œå£°æ˜ï¼š<code>vector&lt;int&gt;</code>ã€<code>vector&lt;bool&gt;</code>ã€<code>vector&lt;double&gt;</code>ã€<code>vector&lt;String&gt;</code>ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>[]</code>è®¿é—®å…ƒç´ ï¼Œä½¿ç”¨<code>.push_back()</code>è¿½åŠ å…ƒç´ ï¼Œä½¿ç”¨<code>.reserve()</code>ä¸ºå‘é‡åˆ†é…å‚¨å­˜ç©ºé—´ã€‚</p>
<p><code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code>å‡½æ•°ç”¨æ¥æ‰§è¡Œæ¸¸ç¨‹ç¼–ç ç®—æ³•ï¼Œç»Ÿè®¡<strong>è¿ç»­ç›¸åŒå…ƒç´ </strong>çš„ä¸ªæ•°ï¼Œè¿”å›valueså’Œå…¶å¯¹åº”çš„lengthï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run Length Encoding</span></span>
<span><span class="co">#&gt;   lengths: int [1:5] 3 2 2 5 2</span></span>
<span><span class="co">#&gt;   values : num [1:5] 1 2 1 3 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä¸‹é¢æ˜¯Rcppç‰ˆï¼š</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>List rleC<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> lengths<span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> values<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialise first value</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> prev <span class="op">=</span> x<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span>push_back<span class="op">(</span>prev<span class="op">);</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  lengths<span class="op">.</span>push_back<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  NumericVector<span class="op">::</span>iterator it<span class="op">;</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span>it <span class="op">=</span> x<span class="op">.</span>begin<span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> it <span class="op">!=</span> x<span class="op">.</span>end<span class="op">();</span> <span class="op">++</span>it<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>prev <span class="op">==</span> <span class="op">*</span>it<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>      lengths<span class="op">[</span>i<span class="op">]++;</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>      values<span class="op">.</span>push_back<span class="op">(*</span>it<span class="op">);</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>      lengths<span class="op">.</span>push_back<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>      i<span class="op">++;</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>      prev <span class="op">=</span> <span class="op">*</span>it<span class="op">;</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> List<span class="op">::</span>create<span class="op">(</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    _<span class="op">[</span><span class="st">"lengths"</span><span class="op">]</span> <span class="op">=</span> lengths<span class="op">,</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    _<span class="op">[</span><span class="st">"values"</span><span class="op">]</span> <span class="op">=</span> values</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="https://en.cppreference.com/w/cpp/container/vector">vector</a>ä¸­æè¿°äº†vectorçš„æ›´å¤šæ–¹æ³•ã€‚</p>
</section><section id="sets" class="level4"><h4 class="anchored" data-anchor-id="sets">Sets</h4>
<p>set åŒ…å«çš„å…ƒç´ ä¸èƒ½é‡å¤ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³æŸ¥æ‰¾é‡å¤æˆ–å”¯ä¸€å…ƒç´ çš„é—®é¢˜ã€‚C++æä¾›äº†æœ‰åºé›†åˆï¼ˆ<code>std::set</code>ï¼‰å’Œæ— åºé›†åˆï¼ˆ<code>std::unordered_set</code>ï¼‰ä¸¤ç§æ•°æ®ç»“æ„ã€‚æ— åºé›†åˆé€šå¸¸è¿è¡Œå¾ˆå¿«ï¼Œæœ‰æ—¶å¯ä»¥ä½¿ç”¨æ— åºé›†åˆ+æ’åºçš„ä¸¤å¸ƒèµ°æ¥æ›¿ä»£æœ‰åºé›†åˆã€‚åŒvectorä¸€æ ·ï¼Œsetä¹Ÿæ˜¯æ¨¡æ¿åŒ–çš„ï¼Œä½ éœ€è¦åŒ…å«ä¸åŒå…ƒç´ çš„setè¿›è¡Œå£°æ˜ï¼š<code>set&lt;int&gt;</code>ã€<code>set&lt;bool&gt;</code>ã€<code>set&lt;double&gt;</code>ã€<code>set&lt;String&gt;</code>ã€‚æ›´å¤šä¿¡æ¯ä½ å¯ä»¥å‚è€ƒ<a href="https://en.cppreference.com/w/cpp/container/set">set</a>å’Œ<a href="https://en.cppreference.com/w/cpp/container/unordered_set">unordered_set</a>ã€‚</p>
<p>ä¸‹é¢æ˜¯Rä¸­<code><a href="https://rdrr.io/r/base/duplicated.html">duplicated()</a></code>å‡½æ•°çš„Rcppå®ç°ï¼Œæ³¨æ„<code>seen.insert(x[i]).second.insert()</code>è¿”å›ä¸€ä¸ªpairå€¼ï¼Œå®ƒçš„<code>.first</code>å€¼æ˜¯ä¸€ä¸ªæŒ‡å‘å…ƒç´ çš„è¿­ä»£å™¨ï¼Œ<code>.second</code>å€¼æ˜¯ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦æ–°æ’å…¥é›†åˆçš„å¸ƒå°”å€¼ï¼š</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp11)]]</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unordered_set&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>LogicalVector duplicatedC<span class="op">(</span>IntegerVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> seen<span class="op">;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  LogicalVector out<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    out<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">!</span>seen<span class="op">.</span>insert<span class="op">(</span>x<span class="op">[</span>i<span class="op">]).</span>second<span class="op">;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="map" class="level4"><h4 class="anchored" data-anchor-id="map">Map</h4>
<p>mapä¸setç±»ä¼¼ï¼Œä½†æ˜¯mapä¸ä»…å¯ä»¥ç”¨æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œè¿˜å…³è”å…¶ä»–æ•°æ®ï¼Œå®ƒç”±é”®å€¼å¯¹ç»„æˆã€‚ååˆ†é€‚åˆRä¸­ç±»ä¼¼<code><a href="https://rdrr.io/r/base/table.html">table()</a></code>æˆ–<code><a href="https://rdrr.io/r/base/match.html">match()</a></code>ç­‰å‡½æ•°çš„å®ç°ã€‚mapä¹Ÿæ˜¯æ¨¡æ¿åŒ–çš„ï¼Œä½†æ˜¯ç”±äºå®ƒåŒæ—¶æœ‰é”®å’Œå€¼ï¼Œæ‰€ä»¥éœ€è¦å£°æ˜ä¸¤ä¸ªç±»å‹ï¼Œä¾‹å¦‚ï¼š<code>map&lt;int, int&gt;</code>ã€<code>map&lt;bool, int&gt;</code>ã€<code>map&lt;double, int&gt;</code>ã€<code>map&lt;String, int&gt;</code>ã€‚mapåŒæ ·åˆ†æœ‰åºï¼ˆ<code>std::map</code>ï¼‰å’Œæ— åºï¼ˆ<code>std::unordered_map</code>ï¼‰ä¸¤ç§ã€‚æ›´å¤šä¿¡æ¯ä½ å¯ä»¥å‚è€ƒ<a href="https://en.cppreference.com/w/cpp/container/map">map</a>å’Œ<a href="https://en.cppreference.com/w/cpp/container/unordered_map">unordered_map</a>ã€‚ ï¼‰ã€‚</p>
<p>ä¸‹é¢æ˜¯Rä¸­<code><a href="https://rdrr.io/r/base/table.html">table()</a></code>å‡½æ•°çš„Rcppå®ç°ï¼š</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>map<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> <span class="dt">int</span><span class="op">&gt;</span> tableC<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>map<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> <span class="dt">int</span><span class="op">&gt;</span> counts<span class="op">;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    counts<span class="op">[</span>x<span class="op">[</span>i<span class="op">]]++;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> counts<span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section></section></section><section id="case-studies" class="level2"><h2 class="anchored" data-anchor-id="case-studies">Case studies</h2>
<p>ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨C++æ›¿æ¢Rä¸­è¿è¡Œç¼“æ…¢å‡½æ•°çš„ä¾‹å­ã€‚</p>
<section id="gibbs-sampler" class="level3"><h3 class="anchored" data-anchor-id="gibbs-sampler">Gibbs sampler</h3>
<p>ç¤ºä¾‹æ¥æºè‡ªDirk Eddelbuettelçš„<a href="http://dirk.eddelbuettel.com/blog/2011/07/14/">blog</a>ã€‚Rå’ŒC++çš„å‰å¸ƒæ–¯é‡‡æ ·å‡½æ•°å®ç°ç±»ä¼¼ï¼Œä½†æ˜¯è¿è¡Œé€Ÿåº¦ç›¸å·®æå¤§ã€‚Dirkåœ¨åšå®¢ä¸­è¿˜å±•ç¤ºäº†å¦ä¸€ç§ä½¿é€Ÿåº¦æ›´å¿«çš„æ–¹æ³•ï¼šä½¿ç”¨GSLï¼ˆRå¯ä»¥é€šè¿‡RcppGSLåŒ…è½»è®¿é—®ï¼‰ä¸­æ›´å¿«çš„éšæœºæ•°ç”Ÿæˆå™¨å‡½æ•°, å¯ä»¥ä½¿é€Ÿåº¦å†æé«˜ä¸¤åˆ°ä¸‰å€ã€‚</p>
<p>Rç‰ˆæœ¬ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gibbs_r</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span>, <span class="va">thin</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">thin</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="va">y</span> <span class="op">*</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">4</span><span class="op">)</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">mat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">mat</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>C++ç‰ˆæœ¬ï¼š</p>
<ul>
<li>å£°æ˜æ‰€æœ‰å˜é‡çš„æ•°æ®ç±»å‹ã€‚</li>
<li>ä½¿ç”¨<code>(</code>è€Œä¸æ˜¯<code>[</code>æ¥è·å–çŸ©é˜µç´¢å¼•ã€‚</li>
<li>å°†<code><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma()</a></code>å’Œ<code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>å‡½æ•°çš„ç»“æœç”±å‘é‡è½¬æ¢ä¸ºæ ‡é‡ã€‚</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>NumericMatrix gibbs_cpp<span class="op">(</span><span class="dt">int</span> N<span class="op">,</span> <span class="dt">int</span> thin<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  NumericMatrix mat<span class="op">(</span>N<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> y <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> thin<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> rgamma<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">1</span> <span class="op">/</span> <span class="op">(</span>y <span class="op">*</span> y <span class="op">+</span> <span class="dv">4</span><span class="op">))[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>      y <span class="op">=</span> rnorm<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span> <span class="op">/</span> <span class="op">(</span>x <span class="op">+</span> <span class="dv">1</span><span class="op">),</span> <span class="dv">1</span> <span class="op">/</span> sqrt<span class="op">(</span><span class="dv">2</span> <span class="op">*</span> <span class="op">(</span>x <span class="op">+</span> <span class="dv">1</span><span class="op">)))[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    mat<span class="op">(</span>i<span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    mat<span class="op">(</span>i<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">=</span> y<span class="op">;</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(</span>mat<span class="op">);</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åŸºå‡†æµ‹è¯•ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="fu">gibbs_r</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  <span class="fu">gibbs_cpp</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 Ã— 6</span></span>
<span><span class="co">#&gt;   expression              min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt;         &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 gibbs_r(100, 10)     1.99ms   2.14ms      441.   102.8KB     17.5</span></span>
<span><span class="co">#&gt; 2 gibbs_cpp(100, 10)  216.8Âµs 239.65Âµs     4000.    1.61KB     16.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="r-vectorisation-versus-c-vectorisation" class="level3"><h3 class="anchored" data-anchor-id="r-vectorisation-versus-c-vectorisation">R vectorisation versus C++ vectorisation</h3>
<p>ç¤ºä¾‹æ¥æºå­<a href="https://gweissman.github.io/post/rcpp-is-smoking-fast-for-agent-based-models-in-data-frames/">â€œRcpp is smoking fast for agent-based models in data framesâ€</a>ã€‚å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ä¸‰ä¸ªè¾“å…¥æ¥é¢„æµ‹ä¸€ä¸ªæ¨¡å‹çš„è¾“å‡ºï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vacc1a</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">0.04</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">ily</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="kw">if</span> <span class="op">(</span><span class="va">female</span><span class="op">)</span> <span class="fl">1.25</span> <span class="kw">else</span> <span class="fl">0.75</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  <span class="va">p</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å½“ä¸‰ä¸ªè¾“å…¥æ˜¯ä¸€ä¸ªå‘é‡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨for-loopæ¥å¤„ç†ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vacc1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">vacc1a</span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">female</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">ily</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ç»“åˆå‰é¢ç« èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤å®š<code>vacc1()</code>è¿è¡Œé€Ÿåº¦ä¼šæ˜¯æ…¢çš„ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³ï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨Rä¸­çš„å‘é‡åŒ–å‡½æ•°<code><a href="https://rdrr.io/r/base/ifelse.html">ifelse()</a></code>ã€<code><a href="https://rdrr.io/r/base/Extremes.html">pmin()</a></code>å’Œ<code><a href="https://rdrr.io/r/base/Extremes.html">pmax()</a></code>æ¥ä»£æ›¿for-loopã€‚</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vacc2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">0.04</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">ily</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">female</span>, <span class="fl">1.25</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  <span class="va">p</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>ä½¿ç”¨C++é‡æ„å‡½æ•°<code>vacc1a()</code>å’Œ<code>vacc1()</code>ã€‚</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> vacc3a<span class="op">(</span><span class="dt">double</span> age<span class="op">,</span> <span class="dt">bool</span> female<span class="op">,</span> <span class="dt">bool</span> ily<span class="op">){</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> p <span class="op">=</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> exp<span class="op">(</span><span class="fl">0.04</span> <span class="op">*</span> age<span class="op">))</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> ily<span class="op">;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> p <span class="op">*</span> <span class="op">(</span>female <span class="op">?</span> <span class="fl">1.25</span> <span class="op">:</span> <span class="fl">0.75</span><span class="op">);</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> <span class="bu">std::</span>min<span class="op">(</span>p<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>NumericVector vacc3<span class="op">(</span>NumericVector age<span class="op">,</span> LogicalVector female<span class="op">,</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>                    LogicalVector ily<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> age<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  NumericVector out<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    out<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> vacc3a<span class="op">(</span>age<span class="op">[</span>i<span class="op">],</span> female<span class="op">[</span>i<span class="op">],</span> ily<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<p>ç”Ÿæˆç¤ºä¾‹æ•°æ®å¹¶è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼š</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">female</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span>, <span class="va">n</span>, rep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ily</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span>, <span class="va">n</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span>, rep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu">vacc1</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span>, <span class="fu">vacc2</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu">vacc1</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span>, <span class="fu">vacc3</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  vacc1 <span class="op">=</span> <span class="fu">vacc1</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span>,</span>
<span>  vacc2 <span class="op">=</span> <span class="fu">vacc2</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span>,</span>
<span>  vacc3 <span class="op">=</span> <span class="fu">vacc3</span><span class="op">(</span><span class="va">age</span>, <span class="va">female</span>, <span class="va">ily</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 Ã— 6</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 vacc1        1.17ms   1.25ms      768.    7.86KB    27.1 </span></span>
<span><span class="co">#&gt; 2 vacc2        64.5Âµs   73.1Âµs    12610.  146.67KB    45.2 </span></span>
<span><span class="co">#&gt; 3 vacc3        36.2Âµs   38.2Âµs    25475.   11.98KB     2.55</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="using-rcpp-in-a-package" class="level2"><h2 class="anchored" data-anchor-id="using-rcpp-in-a-package">Using Rcpp in a package</h2>
<p><code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp()</a></code>å‡½æ•°å¯ä»¥å°†C++è„šæœ¬åµŒå…¥RåŒ…ä¸­ã€‚å°†C++è„šæœ¬ç»‘å®šåˆ°RåŒ…ä¸­æœ‰ä¸‹é¢ä¸‰ç‚¹å¥½å¤„ï¼š</p>
<ul>
<li><p>ä½¿ç”¨è€…å¯ä»¥è„±ç¦»C++å¼€å‘å·¥å…·ï¼Œç›´æ¥ä½¿ç”¨C++ç¼–å†™çš„å‡½æ•°ã€‚</p></li>
<li><p>RåŒ…æ„å»ºç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¤šä¸ªæºæ–‡ä»¶åŠå…¶ä¾èµ–å…³ç³»ã€‚</p></li>
<li><p>è½¯ä»¶åŒ…ä¸ºæµ‹è¯•ã€æ–‡æ¡£å’Œä¸€è‡´æ€§æä¾›äº†é¢å¤–çš„åŸºç¡€å·¥å…·ã€‚</p></li>
</ul>
<p>åœ¨RåŒ…ä¸­ä½¿ç”¨<code>Rcpp</code>å‡½æ•°ï¼Œä½ éœ€è¦ï¼š</p>
<ul>
<li><p>åœ¨<code>scr/</code>ç›®å½•ä¸‹æ”¾ç½®C++æºæ–‡ä»¶ã€‚</p></li>
<li>
<p>åœ¨<code>DESCRIPTION</code>æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p>
<pre><code>LinkingTo: Rcpp
Imports: Rcpp</code></pre>
</li>
<li>
<p>åœ¨<code>NAMESPACE</code>æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p>
<pre><code>useDynLib(mypackage)
importFrom(Rcpp, sourceCpp)</code></pre>
<p>æˆ‘ä»¬éœ€è¦ä»Rcppå¯¼å…¥ä¸€äº›ä¸œè¥¿ï¼ˆä»»ä½•ä¸œè¥¿ï¼‰, ä»¥ä¾¿å†…éƒ¨Rcppä»£ç èƒ½å¤Ÿæ­£ç¡®åŠ è½½ã€‚è¿™æ˜¯Rä¸­çš„ä¸€ä¸ªbugï¼ˆä¸ç¡®å®šç°åœ¨æ˜¯å¦ä¿®å¤ï¼‰ã€‚</p>
</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨<code><a href="https://usethis.r-lib.org/reference/use_rcpp.html">usethis::use_rcpp()</a></code>æ¥å¿«æ·åœ°æ·»åŠ è¿™äº›å†…å®¹ã€‚</p>
<p>åœ¨æ„å»ºRåŒ…æ—¶ï¼Œä½ éœ€è¦å…ˆè¿è¡Œ<code><a href="https://rdrr.io/pkg/Rcpp/man/compileAttributes.html">Rcpp::compileAttributes()</a></code>ã€‚è¯¥å‡½æ•°æ‰«æC++è„šæœ¬ä¸­æœ‰<code>Rcpp::export</code>å±æ€§çš„å‡½æ•°ï¼Œå¹¶ç”Ÿæˆä½¿å‡½æ•°åœ¨Rä¸­å¯ç”¨æ‰€éœ€çš„ä»£ç ã€‚æ¯å½“æ·»åŠ ã€åˆ é™¤æˆ–æ›´æ”¹å‡½æ•°ç­¾åæ—¶ï¼Œéƒ½ä¼šé‡æ–°è¿è¡Œ<code><a href="https://rdrr.io/pkg/Rcpp/man/compileAttributes.html">compileAttributes()</a></code>ã€‚è¿™æ˜¯ç”±devtoolsåŒ…å’ŒRstudioè‡ªåŠ¨å®Œæˆçš„ã€‚</p>
<p>æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒ<code><a href="https://cran.rstudio.com/web/packages/Rcpp/vignettes/Rcpp-package.pdf">vignette("Rcpp-package")</a></code>ã€‚</p>
</section><section id="learning-more" class="level2"><h2 class="anchored" data-anchor-id="learning-more">Learning more</h2>
<p>æœ¬ç« åªæ¶‰åŠäº†Rcppçš„ä¸€å°éƒ¨åˆ†ï¼Œæä¾›äº†ä½¿ç”¨C++é‡å†™æ€§èƒ½ä¸ä½³çš„Rä»£ç çš„åŸºæœ¬å·¥å…·ã€‚å¦‚å‰æ‰€è¿°ï¼ŒRcppè¿˜æœ‰è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œä½¿å¾—å°†Rä¸ç°æœ‰C++ä»£ç æ¥å£å˜å¾—å®¹æ˜“ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><p>å±æ€§çš„å…¶ä»–åŠŸèƒ½åŒ…æ‹¬æŒ‡å®šé»˜è®¤å‚æ•°ã€é“¾æ¥å¤–éƒ¨C++ä¾èµ–é¡¹ä»¥åŠä»åŒ…å¯¼å‡ºC++æ¥å£ã€‚è¿™äº›åŠŸèƒ½åŠæ›´å¤šå†…å®¹å°†åœ¨<code>vinette("Rcpp-attributes")</code>ä¸­ä»‹ç»ã€‚</p></li>
<li><p>è‡ªåŠ¨åˆ›å»ºC++æ•°æ®ç»“æ„å’ŒRæ•°æ®ç»“æ„ä¹‹é—´çš„åŒ…è£…ï¼ŒåŒ…æ‹¬å°†C++ç±»æ˜ å°„åˆ°å¼•ç”¨ç±»ã€‚å¯¹è¿™ä¸ªä¸»é¢˜çš„ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»æ˜¯<code>vienette("Rcpp-modules")</code>ã€‚</p></li>
<li><p>Rcppå¿«é€Ÿå‚è€ƒæŒ‡å—<code><a href="https://cran.rstudio.com/web/packages/Rcpp/vignettes/Rcpp-quickref.pdf">vignette("Rcpp-quickref")</a></code>åŒ…å«äº†Rcppç±»å’Œå¸¸è§ç¼–ç¨‹ä¹ è¯­çš„æœ‰ç”¨æ€»ç»“ã€‚</p></li>
</ul>
<p>å¯ä»¥å…³æ³¨ä¸€ä¸‹<a href="https://www.rcpp.org/">Rcpp homepage</a>æˆ–ç™»å½•<a href="http://lists.r-forge.r-project.org/cgi-bin/mailman/listinfo/rcpp-devel">Rcpp mailing list</a>ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€äº›å¯¹å­¦ä¹ C++å¾ˆæœ‰å¸®åŠ©çš„èµ„æºï¼š</p>
<ul>
<li><p>Effective C++ã€Effective STLã€‚</p></li>
<li><p><a href="http://www.icce.rug.nl/documents/cplusplus/cplusplus.html">C++ Annotations</a></p></li>
<li><p><a href="http://www.cs.helsinki.fi/u/tpkarkka/alglib/k06/">Algorithm Libraries</a></p></li>
</ul>
<p>ç¼–å†™é«˜æ€§èƒ½ä»£ç ä¹Ÿå¯èƒ½éœ€è¦ä½ é‡æ–°æ€è€ƒä½ çš„åŸºæœ¬æ–¹æ³•ï¼Œå¯¹åŸºæœ¬æ•°æ®ç»“æ„å’Œç®—æ³•çš„æ‰å®ç†è§£éå¸¸æœ‰å¸®åŠ©ã€‚ä½ å¯ä»¥å‚è€ƒï¼š</p>
<ul>
<li><p>Algorithm Design Manual</p></li>
<li><p>MITçš„<a href="http://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-046j-introduction-to-algorithms-sma-5503-fall-2005/">Introduction to Algorithms</a></p></li>
<li><p>Algorithms 4th Editionï¼Œ<a href="https://algs4.cs.princeton.edu/home/">textbook</a>ã€‚</p></li>
</ul>


</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://utteranc.es/client.js" repo="hanguojun007/Blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../Books/Advanced R(2e)/24 Improving performance.html" class="pagination-link" aria-label="24 Improving performance">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">24 Improving performance</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>