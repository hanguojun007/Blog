---
title: "02 Manipulate HTML tags from R with {htmltools}"
date: "2026-01-28"
date-modified: "2026-01-28"

format:
  html:
    code-link: true

fig-width: 6
fig-asp: 0.618
out-width: 70%
fig-align: center

knitr:
  opts_chunk:
    collapse: true
    comment: "#>"
    R.options:
      dplyr.print_min: 6
      dplyr.print_max: 6
      pillar.max_footer_lines: 2
      pillar.min_chars: 15
      stringr.view_n: 6
      cli.num_colors: 0
      cli.hyperlink: FALSE
      pillar.bold: TRUE
      width: 77

execute:
  warning: true
  error: true
---

欢迎大家关注我的公众号：RSSPhto
![](/logo.jpg){width=150px}

-----------------------------


htmltools包脱胎自shiny，功能主要涉及两方面：创建HTML-tag和处理web依赖。它的最终目标是实现操纵、组合和重新排列标签，以便从R中创建灵活丰富的HTML结构。

安装htmltools包

```r
# CRAN
install.packages("htmltools")
# development version
remotes::install_github("rstudio/htmltools")
```

下面是一个依赖htmltools包的例子

```r
remotes::install_github("RinteRface/shinyRPG")
library(shinyRPG)
shinyRPGDemo()
```

## Writing HTML Tags from R

使用htmltools包可以很方便地创建HTML标签。这类创建标签的函数有一个共同点：有name的参数会被转换为标签的属性（attributes），没有name的参数被转换为标签包裹的内容（children）。

```{r}
library(htmltools)
div(id = "header", class = "main", "Hello", strong("World"))
```

某些标签具有空属性（empty attributes），比如`<input disabled>`标签，此时可以用`input(disabled = NA)`表示。

```{r}
tags$input(disabled = NA)
```

## Notations

在R终端中使用`htmltools::tags$`时可以显示可用的标签，同时为了方便，有些标签拥有简单的函数，例如`div()`，`h1()`等。

```{r}
# good
h1("This is a title")

# correct but not necessary
tags$h1("This is a title")
```

当然有些标签只能通过`tags$`来创建，比如上面的`<input>`标签。

```{r}
#| error: true
input(disabled = NA)
tags$input(disabled = NA)
```

当需要使用多个`tags$<TAG_NAME>`函数时，可以使用`withTags()`函数，来避免重复输入`tags$`：

```{r}
# Better
withTags(
  nav(div(), ul(li(), li()))
)

# instead of
tags$nav(div(), tags$ul(tags$li(), tags$li()))
```

当你想将多个标签收集到一起时，是用`tagList()`，而不是`list()`。前者结果中拥有额外的`class`属性——`shiny.tag.list`，导致结果完全不同：

```{r}
# good
tag_list_1 <- tagList(
  p("Some text"),
  div("Content")
)

# correct but not optimal
tag_list_2 <- list(
  p("Some text"),
  div("Content")
)

## 内部结构
str(tag_list_1)
str(tag_list_2)

## 结果
tag_list_1
tag_list_2
```

如果使用`as.character()`时，结果也完全不同：

```{r}
as.character(tag_list_1)
as.character(tag_list_2)
```

## Adding new tags

使用`tag()`可以自定义HTML标签，但是要遵循HTML的命名规则。

```{r}
customTag <- tag(
  "test",
  list(class = "test", p("Custom Tag"))
)
str(customTag)
customTag
```

## Alternative way to write tags

`HTML()`函数可以直接包裹HTML文本信息，避免发生转义：

```{r}
div(HTML("Hello <u>World</u>"))
div("Hello <u>World</u>")
```

下面代码的结果相同，但是它们的class属性不同：

```{r}
HTML("<div>Blabla</div>")
div("Blabla")

class(HTML("<div>Blabla</div>"))
class(div("Blabla"))
```

如果你想转换HTML文本为R code，可以使用[html2R](https://github.com/alandipert/html2r/tree/4217b5430e2bfc3af0d841cbefcd94bc1aadbcdf)包，但无法处理非标准属性。

## Playing with tags

### Tags structure

如上所属，一个**shiny tag**对象通常具有：

-   name，即诸如`span`，`div`，`h1`，`p`，`ul`，`li`等标签名，使用`tag$name`访问

-   attributes，即有name的参数，如`class`，`id`，`style`，`src`，`href`，`value`等，使用`tag$attribs`访问

-   children，即没有name的参数，通常是文本或其他标签，使用`tag$children`访问

-   R的class属性——`shiny.tag`

```{r}
# create the tag
myTag <- div(
  class = "divclass",
  id = "first",
  h1("My first child!"),
  span(class = "child", id = "baby", "Crying")
)
myTag
myTag$name
myTag$attribs
myTag$children
class(myTag)
```

可以用过上面的访问函数来修改相应的内容：

```{r}
myTag$children[[2]]$attribs$class <- "adult"
myTag
```

### Practical examples: shinyRPG

通过修改tag对象，可以重塑标签的样式。例如 @fig-2.1 所示，是通过修改`shiny::selectInput()`对象实现的。

![](images/rpgui-select.png){#fig-2.1}

详细的内容见原文 [2.5.2](https://unleash-shiny.rinterface.com/htmltools-overview#htmltools-shinyRPG)

### Useful functions for tags

htmltools包提供了一些函数用来方便的操作标签的内容：

-   `tagAppendAttributes()`，追加属性

-   `tagHasAttribute()`，判断属性是否存在

-   `tagGetAttribute()`，获取属性值

-   `tagSetChildren()`，重置内容，会覆盖所有旧的内容

-   `tagAppendChildren()`，追加内容

-   `tagInsertChildren()`，插入内容

```{r}
myTag <- div("A tag")
myTag

myTag <-tagAppendAttributes(myTag, id = "myid")
myTag

tagHasAttribute(myTag, "id")

tagGetAttribute(myTag, "id")

myTag <- tagSetChildren(myTag, span("Test"))
myTag

myTag <- tagAppendChildren(myTag, span("Test2"))
myTag

myTag <- tagInsertChildren(myTag, span("Test3"), after = 1)
myTag
```

golem包提供了`tagRemoveAttributes()`函数模板来删除属性：

```{r}
tagRemoveAttributes <- function(tag, ...) {
  attrs <- as.character(list(...))
  for (i in seq_along(attrs)) {
    tag$attribs[[ attrs[i] ]] <- NULL
  }
  tag
}

tagRemoveAttributes(myTag, "id")
```

删除内容，可以直接将`NULL`赋给对应的内容即可。

### Conditionally set attributes

在编写自己的函数时，标签的某些属性需要根据情况来添加，此时需要添加判断逻辑。例如：

```{r}
my_button <- function(color = NULL) {
  tags$button(
    style = if (!is.null(color)) paste("color:", color),
    p("Hello")
  )
}

my_button("blue")
my_button()
```

如果不添加`is.null()`判断，单独运行`my_button()`时就会出现:

```html
<button style="color: ">
  <p>Hello</p>
</button>
```

### Using %>%/|>

操作同一个标签时可以使用`magrittr::%>%`或`|>`来省去中间对象：

```{r}
myTag <- div(class = "cl", h1("Hello")) |>
  tagAppendAttributes(id = "myid") |>
  tagAppendChild(p("some extra text here!"))

myTag
```

### Programmatically create children elements

当创建多个相同的标签时，可以使用`lapply()`或`purrr::map()`：

```{r}
# base R
div(lapply(1:5, function(i) span(i)))
# purrr + %>%
purrr::map(1:5, function(i) span(i)) |> div()
```

## Modern {htmltools}