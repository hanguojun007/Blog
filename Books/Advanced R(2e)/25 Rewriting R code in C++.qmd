---
title: "25 Rewriting R code in C++"
date: "2025-08-30"
date-modified: "2025-09-06"

format:
  html:
    code-link: true

fig-width: 6
fig-asp: 0.618
out-width: 70%
fig-align: center

knitr:
  opts_chunk:
    collapse: true
    comment: "#>"
    R.options:
      dplyr.print_min: 6
      dplyr.print_max: 6
      pillar.max_footer_lines: 2
      pillar.min_chars: 15
      stringr.view_n: 6
      cli.num_colors: 0
      cli.hyperlink: FALSE
      pillar.bold: TRUE
      width: 77

execute:
  warning: true
  error: true
---

## Introduction

æœ‰æ—¶ï¼Œå³ä¾¿ä½ æ‰¾å‡ºæ¥ä»£ç çš„è¿è¡Œç“¶é¢ˆï¼ŒåŒæ—¶åšäº†æ‰€æœ‰å¯ä»¥åœ¨Rä¸­åšçš„ä¼˜åŒ–ï¼Œè¿è¡Œä¾ç„¶å¾ˆæ…¢ã€‚è¿™ä»…ä»…æ˜¯å› ä¸ºRæœ¬èº«å°±æ˜¯æ…¢ï¼ˆğŸ¤¦â€ï¼‰ã€‚æœ¬ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨â€œRcppâ€åŒ…å®ç°ç”¨C++é‡å†™å…³é”®å‡½æ•°æ¥æå‡æ€§èƒ½ã€‚

â€œRcppâ€åŒ…æä¾›äº†å¹²å‡€å¯åŠçš„APIæ¥å®ç°C++ä¸Rä¹‹é—´çš„é“¾æ¥ï¼ŒåŒæ—¶éš”ç¦»Ræœ¬èº«çš„å¤æ‚çš„Cçš„APIã€‚è™½ç„¶å®ƒä¹Ÿå¯ä»¥ç”¨æ¥äº›Cæˆ–Fortranä»£ç ï¼Œä½†ç›¸è¾ƒC++ç¨æ˜¾ç—›è‹¦ã€‚

C++å¯ä»¥ç”¨æ¥è§£æä¸‹é¢å…¸å‹çš„ç“¶é¢ˆï¼š

-   æ— æ³•è½»æ˜“å‘é‡åŒ–çš„å¾ªç¯ï¼Œå› ä¸ºåç»­è¿­ä»£ä¾èµ–äºå…ˆå‰çš„è¿­ä»£ã€‚

-   é€’å½’å‡½æ•°ï¼Œæˆ–è€…æ¶‰åŠè°ƒç”¨å‡½æ•°æ•°ç™¾ä¸‡æ¬¡çš„é—®é¢˜ã€‚åœ¨C++ä¸­è°ƒç”¨å‡½æ•°çš„å¼€é”€æ¯”åœ¨Rä¸­ä½å¾—å¤šã€‚

-   éœ€è¦ä½¿ç”¨Ræ²¡æœ‰æä¾›çš„é«˜çº§æ•°æ®ç»“æ„å’Œç®—æ³•çš„é—®é¢˜ã€‚é€šè¿‡æ ‡å‡†æ¨¡æ¿åº“ï¼ˆSTLï¼‰ï¼ŒC++é«˜æ•ˆåœ°å®ç°äº†è®¸å¤šé‡è¦çš„æ•°æ®ç»“æ„ï¼Œä»æœ‰åºæ˜ å°„åˆ°åŒç«¯é˜Ÿåˆ—ã€‚

æœ¬ç« çš„ç›®çš„æ˜¯ä»…è®¨è®ºC++å’Œâ€œRcppâ€çš„é‚£äº›ç»å¯¹å¿…è¦çš„æ–¹é¢ï¼Œä»¥å¸®åŠ©æ¶ˆé™¤ä»£ç ä¸­çš„ç“¶é¢ˆã€‚æˆ‘ä»¬ä¸ä¼šåœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹æˆ–æ¨¡æ¿ç­‰é«˜çº§åŠŸèƒ½ä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´ï¼Œå› ä¸ºé‡ç‚¹æ˜¯ç¼–å†™å°å‹ã€è‡ªåŒ…å«çš„å‡½æ•°ï¼Œè€Œä¸æ˜¯å¤§å‹ç¨‹åºã€‚C++çš„å·¥ä½œçŸ¥è¯†æ˜¯æœ‰ç”¨çš„ï¼Œä½†ä¸æ˜¯å¿…ä¸å¯å°‘çš„ã€‚è®¸å¤šä¼˜ç§€çš„æ•™ç¨‹å’Œå‚è€ƒèµ„æ–™å¯ä»¥å…è´¹è·å¾—ï¼ŒåŒ…æ‹¬ http://www.learncpp.com/ å’Œ https://en.cppreference.com/w/cpp ã€‚å¯¹äºæ›´é«˜çº§çš„ä¸»é¢˜ï¼ŒScott Meyersçš„â€œEffective C++â€ç³»åˆ—æ˜¯ä¸€ä¸ªå—æ¬¢è¿çš„é€‰æ‹©ã€‚

### Outline

-   25.2èŠ‚ï¼šä»‹ç»å¦‚ä½•å°†ç®€å•çš„Rå‡½æ•°è½¬æ¢ä¸ºç­‰ä»·çš„C++å‡½æ•°ï¼Œå¹¶ä»¥æ­¤ä»‹ç»C++ä¸Rçš„ä¸åŒä¹‹å¤„ã€‚
-   25.2.5å°èŠ‚ï¼šä»‹ç»å¦‚ä½•ä½¿ç”¨`sourceCpp()`å‡½æ•°åŠ è½½C++ä»£ç ã€‚
-   25.3èŠ‚ï¼šä»‹ç»å¦‚ä½•ä¿®æ”¹â€œRcppâ€ä¸­çš„å±æ€§ï¼Œå’Œä¸€äº›å…¶ä»–é‡è¦çš„ç±»ã€‚
-   25.4èŠ‚ï¼šä»‹ç»å¦‚ä½•åœ¨C++ä¸­å¤„ç†Rçš„ç¼ºå¤±å€¼ã€‚
-   25.5èŠ‚ï¼šä»‹ç»å¦‚ä½•ä½¿ç”¨æ ‡å‡†æ¨¡æ¿åº“ä¸­çš„ä¸€äº›é‡è¦æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚
-   25.6èŠ‚ï¼šä»‹ç»ä¸¤ä¸ªä½¿ç”¨â€œRcppâ€æå¤§æå‡æ€§èƒ½çš„ä¾‹å­ã€‚
-   25.7èŠ‚ï¼šä»‹ç»å¦‚ä½•å°†C++ä»£ç æ·»åŠ åˆ°RåŒ…ä¸­ã€‚
-   25.8èŠ‚ï¼šä»‹ç»æ›´å¤šæœ‰å…³â€œRcppâ€çš„èµ„æºã€‚

### Prerequisites

```{r}
library(Rcpp)
```

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªC++çš„ç¼–è¯‘ç¯å¢ƒï¼š

-   Windowsï¼šå®‰è£…[Rtools](http://cran.r-project.org/bin/windows/Rtools/)ã€‚
-   Macï¼šå®‰è£…Xcodeã€‚
-   Linuxï¼š`sudo apt-get install r-base-dev`

## Getting started with C++

`cppFunction()`å…è®¸ç›´æ¥åœ¨Rä¸­ç¼–å†™C++ä»£ç ï¼š

```{r}
cppFunction(
  "
  int add(int x, int y, int z) {
    int sum = x + y + z;
    return sum;
  }
  "
)
# add works like a regular R function
add
add(1, 2, 3)
```

è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œâ€œRcppâ€ä¼šç¼–è¯‘C++ä»£ç ï¼Œå¹¶å°†Rå‡½æ•°`add`ä¸C++å‡½æ•°`add`å…³è”èµ·æ¥ã€‚å…³è”è¿‡ç¨‹çš„å¤§é‡åº•å±‚ç»†èŠ‚è¢«â€œRcppâ€è‡ªè¡Œå¤„ç†äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ä¸åŒçš„ä¾‹å­ï¼Œç”±æµ…å…¥æ·±åœ°ä»‹ç»C++çš„è¯­æ³•ã€‚

### No inputs, scalar output

è®©æˆ‘ä»¬ä»¥ä¸€ä¸ªéå¸¸ç®€å•çš„å‡½æ•°å¼€å§‹â€”â€”æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œæ€»æ˜¯è¿”å›æ•´æ•°1ï¼š

``` r
one <- function() 1L
```

ç­‰ä»·çš„C++å‡½æ•°ï¼š

``` cpp
int one() {
  return 1;
}
```

ä½¿ç”¨`cppFunction()`å®ç°åœ¨Rä¸­ä½¿ç”¨è¿™ä¸ªC++å‡½æ•°ï¼š

```{r}
cppFunction(
  "
  int one() {
    return 1;
  }
  "
)
```

ä¸Šé¢çš„ç¤ºä¾‹å±•ç¤ºäº†Rä¸C++ä¹‹é—´çš„ä¸€äº›ä¸»è¦åŒºåˆ«ï¼š

-   åˆ›å»ºå‡½æ•°çš„è¯­æ³•ä¸è°ƒç”¨å‡½æ•°çš„è¯­æ³•ç±»ä¼¼ï¼›ä¸åƒåœ¨Rä¸­é‚£æ ·ä½¿ç”¨èµ‹å€¼æ¥åˆ›å»ºå‡½æ•°ã€‚
-   å¿…é¡»å£°æ˜å‡½æ•°è¿”å›ç»“æœçš„ç±»å‹ã€‚
-   æ ‡é‡ï¼ˆscalarï¼‰ä¸å‘é‡ï¼ˆvectorï¼‰ä¸åŒã€‚Rä¸­çš„æ•°å­—ã€æ•´æ•°ã€å­—ç¬¦ã€é€»è¾‘å‘é‡çš„å¯¹åº”ç¬¦å·æ˜¯ï¼š`NumericVector`ã€`IntegerVector`ã€`CharacterVector`ã€`LogicalVector`ã€‚æ ‡é‡çš„å¯¹åº”ç¬¦å·æ˜¯ï¼š`double`ã€`int`ã€`String`ã€`bool`ã€‚
-   å¿…é¡»æœ‰æ¸…æ™°çš„`return`å£°æ˜æ¥è¿”å›å€¼ã€‚
-   æ¯ä¸ªå£°æ˜å¿…é¡»ä»¥åˆ†å·`;`ç»“æŸã€‚

### Scalar input, scalar output

ç¬¬äºŒä¸ªä¾‹å­æ˜¯`sign()`å‡½æ•°çš„æ ‡é‡ç‰ˆæœ¬ï¼Œæ¥å—ä¸€ä¸ªæ ‡é‡è¾“å…¥ï¼Œå½“è¾“å…¥ä¸ºæ­£æ•°æ—¶è¿”å›1ï¼Œä¸º0æ—¶è¿”å›0ï¼Œä¸ºè´Ÿæ•°æ—¶è¿”å›-1ï¼š

``` r
signR <- function(x) {
  if (x > 0) {
    1
  } else if (x == 0) {
    0
  } else {
    -1
  }
}

cppFunction(
  "
  int signC(int x) {
    if (x > 0) {
      return 1;
    } else if (x == 0) {
      return 0;
    } else {
      return -1;
    }
  }
 "
)
```

C++ç‰ˆçš„å‡½æ•°ä¸­ï¼š

-   å‡½æ•°çš„è¾“å…¥ä¸è¾“å‡ºä¸€æ ·ï¼Œä¹Ÿéœ€è¦å£°æ˜ç±»å‹ã€‚
-   `if`è¯­å¥çš„è¯­æ³•ä¸€æ ·ï¼Œé€€å‡ºå¯ä»¥ä½¿ç”¨`break`ï¼Œä½†æ˜¯è·³è¿‡éœ€è¦ä½¿ç”¨`continue`è€Œé`next` ã€‚

### Vector input, scalar output

Rä¸C++æœ‰ä¸€ä¸ªæ˜¾è‘—çš„ä¸åŒæ˜¯åœ¨forå¾ªç¯çš„èµ„æºæ¶ˆè€—ä¸Šï¼ŒC++æ›´ä½ã€‚ä¾‹å¦‚ï¼Œåœ¨forå¾ªç¯ä¸­æ‰§è¡Œ`sum`å‡½æ•°ï¼š

Rç‰ˆæœ¬ï¼š

```{r}
sumR <- function(x) {
  total <- 0
  for (i in seq_along(x)) {
    total <- total + x[i]
  }
  total
}
```

C++ç‰ˆæœ¬ï¼š

```{r}
cppFunction(
  "
  double sumC(NumericVector x) {
    int n = x.size();
    double total = 0;
    for(int i = 0; i < n; ++i) {
      total += x[i];
    }
    return total;
  }
  "
)
```

C++ç‰ˆä¸Rç‰ˆæœ¬åœ¨ç»“æ„ä¸Šå¾ˆç›¸ä¼¼ï¼Œä½†ï¼š

-   è·å–å‘é‡é•¿åº¦ï¼ŒC++é€šè¿‡`.size()`æ–¹æ³•å®Œæˆã€‚C++é€šè¿‡`.`æ¥è°ƒç”¨æ–¹æ³•ã€‚

-   `for`çš„å£°æ˜è¯­æ³•ä¸ä¸€æ ·ï¼š`for(init; check; increment)`ã€‚é¢å¤–è®¾ç½®å˜é‡`i`ï¼Œåˆ¤æ–­`i`ä¸`n`çš„æ¯”è¾ƒã€‚

-   C++ä¸­ä½ç½®ç´¢å¼•çš„èµ·å§‹æ˜¯0ã€‚

-   ä½¿ç”¨`=`èµ‹å€¼ï¼Œè€Œä¸æ˜¯`<-`ã€‚

-   C++æä¾›åŸä½ä¿®æ”¹è¿ç®—ç¬¦ï¼š`total += x[i]`ã€‚é™¤æ­¤è¿˜æœ‰`-=`ã€`*=`ã€`/=`ã€‚

```{r}
x <- runif(1e3)
bench::mark(
  sum(x),
  sumC(x),
  sumR(x)
)[1:6]
```

### Vector input, vector output

ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè®¡ç®—å•ä¸ªå€¼ä¸å‘é‡çš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼š

Rç‰ˆæœ¬ï¼š

```{r}
pdistR <- function(x, ys) {
  sqrt((x - ys)^2)
}
```

åœ¨Rä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨å‡½æ•°ä¸­å®šä¹‰`x`æ˜¯æ ‡é‡ï¼Œè€Œæ˜¯åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜è¿™ä¸€ç‚¹ã€‚åœ¨C++ç‰ˆæœ¬ä¸­ï¼Œåˆ™å¿…é¡»æ˜ç¡®è¯´æ˜ç±»å‹ï¼š

```{r}
cppFunction(
  "
  NumericVector pdistC(double x, NumericVector ys) {
    int n = ys.size();
    NumericVector out(n);

    for(int i = 0; i < n; ++i) {
      out[i] = sqrt(pow(ys[i] - x, 2.0));
    }

    return out;
  }
  "
)
```

è¿™ä¸ªC++å‡½æ•°å¼•å…¥äº†ä¸€äº›æ–°æ¦‚å¿µï¼š

-   åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º`n`çš„æ•°å­—å‘é‡éœ€è¦æ„é€ å™¨ï¼š`NumericVector out(n)`ã€‚æ‹·è´ä¸€ä¸ªéœ€è¦ï¼š`NumericVector zs = clone(ys)`ã€‚

-   ä½¿ç”¨`pow()`è€Œé`^`è®¡ç®—å¹‚ã€‚

```{r}
y <- runif(1e6)
bench::mark(
  pdistR(0.5, y),
  pdistC(0.5, y)
)[1:6]
```

ä¸Šé¢çš„ç»“æœæ˜¾ç¤ºï¼ŒC++å¹¶æ²¡æœ‰æ¯”Rå¿«å¤šå°‘ï¼ŒèŠ‚çº¦çš„æ—¶é—´ä¸å¼€å‘C++å‡½æ•°çš„æ—¶é—´ç›¸æ¯”ä¸å€¼ä¸€æã€‚è€Œä¸”C++è¿è¡Œå¿«é€Ÿçš„çœŸæ­£åŸå› æ˜¯å®ƒåªæ˜¯ç”¨äº†é›¶æ—¶æ ‡é‡`ys[i] -x`ï¼Œè€ŒRä½¿ç”¨äº†ä¸´æ—¶å‘é‡`x - ys`ï¼Œé¢å¤–åˆ†é…çš„å†…å­˜ä¼šå ç”¨å¤§é‡æ—¶é—´ã€‚

### Using sourceCpp

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦ä½¿ç”¨`sourceCpp()`æ¥å•ç‹¬åŠ è½½C++è„šæœ¬ã€‚åœ¨ä½¿ç”¨æ”¯æŒC++çš„IDEç¼–å†™è„šæœ¬å¯ä»¥æä¾›è¯­æ³•é«˜äº®ï¼Œè‡ªåŠ¨è¡¥é½ï¼Œè¯­æ³•æ£€æŸ¥ç­‰åŠŸèƒ½ã€‚

ç‹¬ç«‹çš„C++è„šæœ¬éœ€è¦åŠ è½½`.cpp`æ’ä»¶ï¼š

``` cpp
#include <Rcpp.h>
using namespace Rcpp;
```

åŒæ—¶æ¯ä¸ªå‡½æ•°å‰éœ€è¦å£°æ˜`// [[Rcpp::export]]`æ‰å¯ä»¥è¢«Rè°ƒç”¨ã€‚

ä½ ä¹Ÿå¯ä»¥åœ¨C++æ³¨é‡Šå—ä¸­æ’å…¥Rä»£ç ï¼Œåœ¨æµ‹è¯•æ—¶ï¼Œä¼šè¢«æ‰§è¡Œå¹¶åœ¨Rç»ˆç«¯è¾“å‡ºç»“æœï¼ˆå› ä¸º`source(echo = TRUE)`ï¼‰ï¼š

``` cpp
/*** R
# This is R code
*/
```

è¿è¡Œ`sourceCpp("path/to/file.cpp")`ä¼šåˆ›å»ºå¯¹åº”çš„Rå‡½æ•°ï¼Œå¹¶åŠ è½½åˆ°å½“å‰ç¯å¢ƒã€‚éœ€è¦æ³¨æ„ï¼šè¿™äº›å‡½æ•°æ— æ³•è¢«ä¿å­˜åœ¨`.Rdata`æ–‡ä»¶ä¸­ï¼Œæ¯æ¬¡å¯åŠ¨Réƒ½éœ€è¦é‡æ–°åˆ›å»ºã€‚

ä¾‹å¦‚ï¼Œè¿è¡Œ`sourceCpp()`åŠ è½½ä¸‹é¢çš„è„šæœ¬ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º`meanC`çš„å‡½æ•°ï¼Œå¹¶åŠ è½½åˆ°å½“å‰ç¯å¢ƒï¼š

``` cpp
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double meanC(NumericVector x) {
  int n = x.size();
  double total = 0;

  for(int i = 0; i < n; ++i) {
    total += x[i];
  }
  return total / n;
}

/*** R
x <- runif(1e5)
bench::mark(
  mean(x),
  meanC(x)
)
*/
```

åœ¨Rmarkdownä¸­ï¼Œå¯ä»¥è®¾ç½®`{r, engine = "Rcpp"}`è¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥åç»­çš„C++å‡½æ•°å®šä¹‰éƒ½å•ç‹¬æ”¾åœ¨ä¸€ä¸ªä»£ç å—ä¸­ï¼Œæ­¤æ—¶ä¸èƒ½æ·»åŠ æ³¨é‡Šäº†å“¦ã€‚

## Other classes

å‰é¢ä»‹ç»äº†â€œRcppâ€æ”¯æŒçš„åŸºç¡€å‘é‡ç±»å‹ï¼š`NumericVector`ã€`IntegerVector`ã€`CharacterVector`ã€`LogicalVector`ï¼ŒåŸºç¡€æ ‡é‡ç±»å‹ï¼š`double`ã€`int`ã€`String`ã€`bool`ã€‚â€œRcppâ€ä¹Ÿæ”¯æŒå…¶ä»–æ•°æ®ç±»å‹ï¼Œé‡è¦çš„å¦‚ï¼Œlistï¼Œdataframeï¼Œfunctionï¼Œattributeã€‚åŒæ—¶å®ƒä¹Ÿå¯¹å¾ˆå¤šç±»æä¾›æ”¯æŒå¦‚ï¼Œ`Environment`ï¼Œ`DottedPair`ï¼Œ`Language`ï¼Œ`Symbol`ç­‰ï¼Œä½†è¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ã€‚ï¼ˆæ‰€è°“çš„â€œæ”¯æŒâ€å°±æ˜¯è¯´ï¼ŒC++ä»£ç å¯ä»¥è®¿é—®Rå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªRå¯¹è±¡ã€‚ï¼‰

### Lists and data frames

â€œRcppâ€æä¾›äº†å¯¹listå’Œdata frameçš„æ”¯æŒï¼Œä½†å®ƒä»¬å¸¸ç”¨æ¥ä½œä¸ºè¾“å‡ºä½¿ç”¨ï¼Œè€Œéè¾“å…¥ã€‚è¿™æ˜¯å› ä¸ºå®ƒä»¬å¯ä»¥æœ‰ä»»æ„çš„é™„åŠ å±æ€§ï¼Œå½“ä½œä¸ºè¾“å…¥æ—¶ï¼ŒC++éœ€è¦æå‰çŸ¥é“è¿™äº›å±æ€§ã€‚å¦‚æœ list çš„ç»“æ„å·²çŸ¥ä¸”å›ºå®šï¼ŒC++å¯ä»¥æå–å®ƒçš„å…ƒç´ å¹¶ä½¿ç”¨`as()`å°†å…¶è½¬æ¢ä¸ºå…¶ä»–ç±»å‹ã€‚ä¾‹å¦‚ï¼š`lm()`ç”Ÿæˆçš„ç»“æœåŒ…å«çš„å†…å®¹æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä»ç»“æœä¸­æŠ½å–å¯¹åº”çš„å…ƒç´ è®¡ç®—â€œå¹³å‡ç™¾åˆ†æ¯”è¯¯å·®â€ï¼ˆ`mpe()`ï¼‰ã€‚

```{r, engine = "Rcpp"}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double mpe(List mod) {
  if (!mod.inherits("lm")) stop("Input must be a linear model");

  NumericVector resid = as<NumericVector>(mod["residuals"]);
  NumericVector fitted = as<NumericVector>(mod["fitted.values"]);

  int n = resid.size();
  double err = 0;
  for(int i = 0; i < n; ++i) {
    err += resid[i] / (fitted[i] + resid[i]);
  }
  return err / n;
}
```

æ³¨æ„ï¼šä½¿ç”¨`.inherits()`æ£€æŸ¥å¯¹è±¡ç±»å‹æ˜¯å¦çœŸçš„æ˜¯â€œlmâ€ã€‚

```{r}
mod <- lm(mpg ~ wt, data = mtcars)
mpe(mod)
```

### Functions

C++å¯ä»¥ä½¿ç”¨`Function`ç±»ç›´æ¥è®¿é—®Rå‡½æ•°ï¼Œä½†æ˜¯å› ä¸ºè¾“å‡ºçš„ç»“æœç±»å‹ä¸ç¡®å®šï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨`RObject`ç±»ã€‚

```{r, engine = "Rcpp"}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
RObject callWithOne(Function f) {
  return f(1);
}
```

```{r}
callWithOne(function(x) x + 1)
callWithOne(paste)
```

å½“å‡½æ•°`f`ä½¿ç”¨ä½ç½®ç´¢å¼•è·å–å‚æ•°æ—¶ï¼š

``` cpp
f("y", 1);
```

ä½¿ç”¨å¸¦æœ‰åç§°çš„å‚æ•°ï¼š

``` cpp
f(_["x"] = "y", _["value"] = 1);
```

### Attributes

C++å¯ä»¥ä½¿ç”¨`.attr()`è®¿é—®Rå¯¹è±¡çš„å±æ€§ã€‚`.names()`å¯ä»¥ç›´æ¥è·å–nameå±æ€§ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ³¨æ„å¯ä»¥ä½¿ç”¨ç±»æ–¹æ³•`::create()`ç”±C++æ ‡é‡åˆ›å»ºRå‘é‡ã€‚

```{r, engine = "Rcpp"}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector attribs() {
  NumericVector out = NumericVector::create(1, 2, 3);

  out.names() = CharacterVector::create("a", "b", "c");
  out.attr("my-attr") = "my-value";
  out.attr("class") = "my-class";

  return out;
}
```

å¯¹äºS4å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨`.slot()`ã€‚

## Missing values

å¦‚æœä½ æƒ³ä½¿ç”¨ç¼ºå¤±å€¼ï¼Œä½ éœ€è¦çŸ¥é“ä¸¤ä»¶äº‹ï¼š

-   C++çš„æ ‡é‡ç±»å‹å¦‚ä½•å¤„ç†ç¼ºå¤±å€¼ã€‚
-   C++çš„å‘é‡ç±»å‹å¦‚ä½•è·å–å’Œè®¾ç½®ç¼ºå¤±å€¼ã€‚

::: callout-note
æ³¨æ„ï¼šä¸‹é¢å¯¹æ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œæœ‰äº›æ˜¯C++åŸç”Ÿç±»å‹ï¼Œæœ‰äº›æ˜¯Rcppè‡ªå®šä¹‰ã€‚Rcppå®šä¹‰çš„ç±»å‹å¯ä»¥å®Œç¾åœ°é€‚é…ç¼ºå¤±å€¼ã€‚
:::

### Scalars

ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†ï¼šå°†Rçš„ç¼ºå¤±å€¼è½¬æ¢ä¸ºC++æ ‡é‡ï¼Œç„¶åå†è½¬å›ä¸ºRå‘é‡ã€‚è¿™æ˜¯ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬å¼„æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

```{r, engine = "Rcpp"}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
List scalar_missings() {
  int int_s = NA_INTEGER;
  String chr_s = NA_STRING;
  bool lgl_s = NA_LOGICAL;
  double num_s = NA_REAL;

  return List::create(int_s, chr_s, lgl_s, num_s);
}
```

```{r}
str(scalar_missings())
```

ä»ç»“æœæ¥çœ‹ï¼Œé™¤äº†`bool`ï¼Œå…¶ä»–ç±»å‹çš„ç¼ºå¤±å€¼éƒ½æ­£å¸¸ã€‚å®é™…ä¸Šï¼Œäº‹æƒ…å¹¶ä¸æ˜¯å¦‚æ­¤ç®€å•ã€‚

#### Integers

åœ¨C++ä¸­ï¼Œæ•´æ•°ç¼ºå¤±å€¼è¢«å‚¨å­˜ä¸ºæœ€å°æ•´æ•°ã€‚å¦‚æœä½ ä¸å¯¹å®ƒåšä»»ä½•å¤„ç†ï¼Œå®ƒä¼šæ˜¾å¾—å¾ˆæ­£å¸¸ã€‚å¦‚æœä½ å¯¹å®ƒåšäº†ä¸€äº›å¤„ç†ï¼Œå¦‚`NA_INTEGER + 1`ï¼Œå› ä¸ºC++å¹¶ä¸çŸ¥é“æœ€å°æ•´æ•°åœ¨æ­¤å¤„ä»£è¡¨ç¼ºå¤±å€¼ï¼Œå®ƒä¼šè¿›è¡Œè®¡ç®—è¿”å›å€¼ã€‚

```{r}
evalCpp("NA_INTEGER + 1")
```

å¦‚æœä½ æƒ³åº”ç”¨æ•´æ•°ç¼ºå¤±å€¼ï¼Œå¯ä»¥ä½¿ç”¨é•¿åº¦ä¸º1çš„`IntegerVector`æˆ–ä»”ç»†æ§åˆ¶ä»£ç å¯¹ç¼ºå¤±å€¼çš„å¤„ç†ã€‚

#### Doubles

å¯¹äºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä½ æˆ–è®¸å¯ä»¥ä¸ç”¨ç†ä¼šç¼ºå¤±å€¼ï¼Œç›´æ¥å¤„ç†NaNï¼ˆéæ•°å­—ï¼‰ã€‚è¿™æ˜¯å› ä¸ºRè¯­è¨€ä¸­çš„NAæ˜¯ IEEE 754 æµ®ç‚¹æ•° NaN çš„ä¸€ç§ç‰¹æ®Šç±»å‹ã€‚å› æ­¤ï¼Œä»»ä½•æ¶‰åŠNaNï¼ˆåœ¨ C++ ä¸­ä¸º NANï¼‰çš„é€»è¾‘è¡¨è¾¾å¼çš„æ±‚å€¼ç»“æœéƒ½å§‹ç»ˆä¸º FALSEï¼š

```{r}
evalCpp("NAN == 1")
evalCpp("NAN < 1")
evalCpp("NAN > 1")
evalCpp("NAN == NAN")
```

ä»»ä½•æ•°å­—ä¸NaNcyè¿›è¡Œè®¡ç®—éƒ½ä¼šäº§ç”ŸNaNï¼š

```{r}
evalCpp("NAN + 1")
evalCpp("NAN - 1")
evalCpp("NAN / 1")
evalCpp("NAN * 1")
```

ä½†æ˜¯ä¸å¸ƒå°”å€¼è®¡ç®—æ—¶è¦å°å¿ƒï¼š

```{r}
evalCpp("NAN && TRUE")
evalCpp("NAN || FALSE")
```

#### Strings

`String`ç”±â€œRcppâ€å®šä¹‰ï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç†ç¼ºå¤±å€¼ã€‚

#### Boolean

C++ä¸­çš„`bool`ç±»å‹åªæœ‰`true`å’Œ`false`ï¼Œè€ŒRè¯­è¨€ä¸­çš„`logical`ç±»å‹æœ‰`TRUE`ã€`FALSE`å’Œ`NA`ï¼Œä½ å¯ä»¥ä½¿ç”¨`int`ç±»å‹æ¥å®ç°ç¼ºå¤±å€¼ï¼ˆ`NA_INTEGER`ï¼‰ã€‚å¦‚æœä½ è¦å°†ä¸€ä¸ªé•¿åº¦ä¸º1çš„R-logicalå‘é‡è½¬æ¢ä¸ºC++çš„`bool`ï¼Œéœ€è¦æ³¨æ„ç¼ºå¤±å€¼ï¼Œå› ä¸ºå®ƒä¼šè¢«è½¬æ¢ä¸º`true`ã€‚

### Vectors

å¯¹äºå‘é‡ï¼Œâ€œRcppâ€æœ‰å®šä¹‰å¥½çš„ç¼ºå¤±å€¼ç±»å‹ï¼š`NA_REAL`ã€`NA_INTEGER`ã€`NA_STRING`ã€`NA_LOGICAL`ã€‚

```{r, engine = "Rcpp"}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
List missing_sampler() {
  return List::create(
    NumericVector::create(NA_REAL),
    IntegerVector::create(NA_INTEGER),
    LogicalVector::create(NA_LOGICAL),
    CharacterVector::create(NA_STRING)
  );
}
```

```{r}
str(missing_sampler())
```

## Standard Template Library

C++çœŸå®çš„ä¼˜åŠ¿ä½“ç°åœ¨å®ƒçš„æ ‡å‡†æ¨¡æ¿åº“ä¸Šï¼Œå½“ä½ éœ€è¦æ‰§è¡Œå¤æ‚ç®—æ³•æ—¶ï¼ŒSTLæä¾›äº†ä¸€å¥—æå…¶æœ‰ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚æœ¬èŠ‚å°†è§£é‡Šä¸€äº›æœ€é‡è¦çš„ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå¹¶ä¸ºæŒ‡æ˜æ­£ç¡®çš„å­¦ä¹ æ–¹å‘ï¼Œå¸Œæœ›è¿™äº›ç¤ºä¾‹èƒ½å‘ä½ å±•ç¤ºSTLçš„å¼ºå¤§åŠŸèƒ½ï¼Œå¹¶è¯´æœä½ ç›¸ä¿¡å­¦ä¹ æ›´å¤šçŸ¥è¯†æ˜¯æœ‰ç”¨çš„ã€‚

å¦‚æœä½ éœ€è¦çš„æŸä¸ªæ•°æ®ç»“æ„æˆ–ç®—æ³•ä¸åœ¨STLä¸­ï¼Œä½ å¯ä»¥åœ¨[boost](https://www.boost.org/libraries/latest/grid/)ä¸­æ‰¾æ‰¾ã€‚ä¸€æ—¦ä½ åœ¨ç”µè„‘ä¸Šå®‰è£…äº†boostï¼Œä½ å¯ä»¥åœ¨å¤´æ–‡ä»¶ä¸­å†™ä¸‹`#include <boost/test.hpp>`æ¥ä½¿ç”¨boostä¸­çš„ç®—æ³•ã€‚

### Using iterators

è¿­ä»£å™¨ï¼ˆiteratorï¼‰åœ¨STLä¸­åº”ç”¨å¹¿æ³›ï¼Œè®¸å¤šå‡½æ•°æ¥å—æˆ–è¿”å›è¿­ä»£å™¨ã€‚å®ƒä»¬æ—¶åŸºç¡€for-loopçš„å‡çº§ï¼ŒæŠ½è±¡å‡ºåº•å±‚æ•°æ®ç»“æ„çš„ç»†èŠ‚ã€‚è¿­ä»£å™¨æœ‰ä¸‰ä¸ªä¸»è¦æ“ä½œç¬¦ï¼š

-   `*`ï¼šè¿”å›è¿­ä»£å™¨æŒ‡å‘çš„å…ƒç´ ã€‚
-   `++`ï¼šå°†è¿­ä»£å™¨æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚
-   `==`ï¼šæ¯”è¾ƒä¸¤ä¸ªè¿­ä»£å™¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå…ƒç´ ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿­ä»£å™¨é‡å†™â€œsumâ€å‡½æ•°ï¼š

``` cpp
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double sum3(NumericVector x) {
  double total = 0;

  NumericVector::iterator it;
  for(it = x.begin(); it != x.end(); ++it) {
    total += *it;
  }
  return total;
}
```

ç›¸è¾ƒäºfor-loopï¼Œè¿­ä»£å™¨çš„ä¸»è¦æ”¹å˜æœ‰ï¼š

-   å¾ªç¯å¼€å§‹äº`x.begin()`ï¼Œç»“æŸäº`x.end()`ã€‚è¿­ä»£å™¨ä½¿ç”¨`x.end`å‚¨å­˜äº†å¾ªç¯çš„æœ«å°¾å€¼ï¼Œå‡å°‘äº†æ¯æ¬¡è¿­ä»£æ—¶è¿›è¡ŒæŸ¥è¯¢æœ«å°¾å€¼çš„å·¥ä½œã€‚

-   ä½¿ç”¨è§£å¼•ç¬¦`*`è·å–è¿­ä»£å™¨æŒ‡å‘çš„å…ƒç´ ã€‚

-   æ¯ç§æ•°æ®ç±»å‹æœ‰å®ƒè‡ªå·±çš„è¿­ä»£å™¨ï¼š`NumericVector::iterator`ã€`IntegerVector::iterator`ã€`LogicalVector::iterator`ã€`CharacterVector::iterator`ã€‚

ä¸Šé¢çš„ä»£ç å¯ä»¥ä½¿ç”¨C++11çš„range-based for-loopé‡å†™ï¼ŒRcppä½¿ç”¨`[[Rcpp::plugins(cpp11)]]`æ¿€æ´»ï¼š

``` cpp
// [[Rcpp::plugins(cpp11)]]
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double sum4(NumericVector xs) {
  double total = 0;

  for(const auto &x : xs) {
    total += x;
  }
  return total;
}
```

è¿­ä»£å™¨ä¹Ÿå…è®¸æˆ‘ä»¬ä½¿ç”¨C++ä¸­ç›¸å½“äºapplyçš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`accumulate()`å‡½æ•°å†æ¬¡é‡å†™`sum()`ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªèµ·å§‹è¿­ä»£å™¨å’Œä¸€ä¸ªç»“æŸè¿­ä»£å™¨ï¼Œå¹¶å°†`vector`ä¸­çš„æ‰€æœ‰å€¼ç›¸åŠ ã€‚`accumulate()`çš„ç¬¬ä¸‰ä¸ªå‚æ•°ç»™å‡ºäº†åˆå§‹å€¼ï¼šå®ƒç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºå®ƒå†³å®šäº†`accumulate()`ä½¿ç”¨çš„æ•°æ®ç±»å‹ï¼ˆä½¿ç”¨`0.0`è¡¨ç¤º`accumulate()`ä½¿ç”¨çš„æ˜¯`double`ï¼Œä½¿ç”¨`0`è¡¨ç¤º`int`ï¼‰ã€‚è¦ä½¿ç”¨`accumulate()`ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¤´æ–‡ä»¶ä¸­å¼•å…¥`<Numeric>`ã€‚

``` cpp
#include <numeric>
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double sum5(NumericVector x) {
  return std::accumulate(x.begin(), x.end(), 0.0);
}
```

### Algorithms

å¤´æ–‡ä»¶`<algorithm>`æä¾›äº†å¤§é‡äºä½¿ç”¨è¿­ä»£å™¨çš„ç®—æ³•ï¼Œä½ å¯ä»¥å‚è€ƒ[en.cppreference.com](https://en.cppreference.com/w/cpp/algorithm)ã€‚

`findInterval()`å‡½æ•°æ¥å—ä¸€ä¸ªå‘é‡å’Œä¸€ä¸ªåŒºé—´å‘é‡ï¼Œè¿”å›ä¸€ä¸ªå‘é‡ï¼Œè¯¥å‘é‡åŒ…å«æ¯ä¸ªå…ƒç´ åœ¨åŒºé—´å‘é‡ä¸­çš„ç´¢å¼•ï¼š

```{r}
x <- 2:18
v <- c(5, 10, 15) # create two bins [5,10) and [10,15)
cbind(x, findInterval(x, v))
```

ä¸‹é¢æ˜¯Rcppç‰ˆçš„åŸºç¡€å®ç°ï¼š

``` cpp
#include <algorithm>
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
IntegerVector findInterval2(NumericVector x, NumericVector breaks) {
  IntegerVector out(x.size());

  NumericVector::iterator it, pos;
  IntegerVector::iterator out_it;

  for(it = x.begin(), out_it = out.begin(); it != x.end();
      ++it, ++out_it) {
    pos = std::upper_bound(breaks.begin(), breaks.end(), *it);
    *out_it = std::distance(breaks.begin(), pos);
  }

  return out;
}
```

å…³é”®ç‚¹ï¼š

-   åŒæ—¶è¾“å…¥ä¸¤ä¸ªè¿­ä»£å™¨ï¼Œ`it`å’Œ`out_it`ã€‚

-   ä½¿ç”¨`*out_it`æ¥ä¿®æ”¹`out`çš„å€¼ã€‚

-   `upper_bound()`è¿”å›è¿­ä»£å™¨`pos`ï¼Œç„¶åä½¿ç”¨`std::distance()`æ‰¾åˆ°å®ƒåœ¨`breaks`ä¸­çš„ç´¢å¼•ã€‚

-   tipsï¼šRä¸­çš„`findInterval()`å·²ç»æ˜¯ä½¿ç”¨Cå®ç°çš„ã€‚å¦‚æœæƒ³ä¸Šé¢çš„å‡½æ•°å’ŒRä¸­çš„ä¸€æ ·å¿«ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—ä¸€æ¬¡å¯¹`.begin()`å’Œ`.end()`çš„è°ƒç”¨ï¼Œå¹¶ä¿å­˜ç»“æœã€‚è¿™æ ·åšä¼šåˆ†æ•£æˆ‘ä»¬çš„æ³¨æ„åŠ›ï¼Œæ‰€ä»¥å¿½ç•¥äº†è¿™ä¸ªä¼˜åŒ–ã€‚æ·»åŠ è¿™ä¸€æ­¥éª¤å¯ä»¥ç”Ÿæˆæ¯”Rçš„`findInterval()`æ›´å¿«çš„ä»£ç ï¼Œä½†æ˜¯ä»£ç é‡æ›´å°‘ï¼Œå¤§çº¦æ˜¯Råº•å±‚çš„1/10ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨ST ä¸­çš„ç®—æ³•æ¯”ä½¿ç”¨æ‰‹åŠ¨å¾ªç¯æ›´å¥½ã€‚åœ¨ã€ŠEffective STLã€‹ä¸€ä¹¦ä¸­ï¼ŒScott Meyers ç»™å‡ºäº†ä¸‰ä¸ªåŸå› ï¼šæ•ˆç‡ã€æ­£ç¡®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚STLä¸­çš„ç®—æ³•ç”±C++ä¸“å®¶ç¼–å†™ï¼Œéå¸¸é«˜æ•ˆï¼Œè€Œä¸”å®ƒä»¬å·²ç»å­˜åœ¨äº†å¾ˆé•¿æ—¶é—´ï¼Œå¹¶ä¸”ç»è¿‡äº†å……åˆ†çš„æµ‹è¯•ã€‚ä½¿ç”¨æ ‡å‡†ç®—æ³•è¿˜èƒ½ä½¿ä»£ç çš„æ„å›¾æ›´åŠ æ˜ç¡®ï¼Œæœ‰åŠ©äºä½¿å…¶æ›´åŠ å¯è¯»å’Œå¯ç»´æŠ¤ã€‚

### Data structures

STLæä¾›äº†å¤§é‡æ•°æ®ç»“æ„ï¼š`array`,Â `bitset`,Â `list`,Â `forward_list`,Â `map`,Â `multimap`,Â `multiset`,Â `priority_queue`,Â `queue`,Â `deque`,Â `set`,Â `stack`,Â `unordered_map`,Â `unordered_set`,Â `unordered_multimap`,Â `unordered_multiset`, `vector`. å…¶ä¸­æœ€é‡è¦çš„æ˜¯ï¼š`vector`, `unordered_set`,Â `unordered_map`ã€‚æœ¬èŠ‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»è¿™ä¸‰ç§æ•°æ®ç»“æ„ï¼Œå…¶ä»–æ•°æ®ç»“æ„çš„ä½¿ç”¨æ–¹æ³•ç›¸ä¼¼ï¼Œåªæ˜¯æ€§èƒ½ç•¥æœ‰ä¸åŒã€‚ä½ å¯ä»¥å‚è€ƒ[en.cppreference.com](https://en.cppreference.com/w/cpp/container)ã€‚

RcppçŸ¥é“å¦‚ä½•å°†è®¸å¤šSTLæ•°æ®ç»“æ„è½¬æ¢ä¸ºRç­‰ä»·ç‰©ï¼Œå› æ­¤ä½ å¯ä»¥ä»å‡½æ•°ä¸­è¿”å›å®ƒä»¬ï¼Œè€Œæ— éœ€æ˜¾å¼è½¬æ¢ä¸ºRæ•°æ®ç»“æ„ã€‚

#### Vectors

STL vector ä¸Rä¸­çš„vector ç±»ä¼¼ï¼Œä½†å®ƒèƒ½é«˜æ•ˆæ‰©å®¹ï¼Œé€‚åˆåœ¨ä½ ä¸çŸ¥é“è¾“å‡ºå‘é‡çš„å¤§å°æ—¶ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvectoræ˜¯æ¨¡æ¿åŒ–çš„ï¼Œä½ éœ€è¦åŒ…å«ä¸åŒå…ƒç´ çš„å‘é‡è¿›è¡Œå£°æ˜ï¼š`vector<int>`ã€`vector<bool>`ã€`vector<double>`ã€`vector<String>`ã€‚ä½ å¯ä»¥ä½¿ç”¨`[]`è®¿é—®å…ƒç´ ï¼Œä½¿ç”¨`.push_back()`è¿½åŠ å…ƒç´ ï¼Œä½¿ç”¨`.reserve()`ä¸ºå‘é‡åˆ†é…å‚¨å­˜ç©ºé—´ã€‚

`rle()`å‡½æ•°ç”¨æ¥æ‰§è¡Œæ¸¸ç¨‹ç¼–ç ç®—æ³•ï¼Œç»Ÿè®¡**è¿ç»­ç›¸åŒå…ƒç´ **çš„ä¸ªæ•°ï¼Œè¿”å›valueså’Œå…¶å¯¹åº”çš„lengthï¼š

```{r}
x <- c(1,1,1,2,2,1,1,3,3,3,3,3,4,4)
rle(x)
```

ä¸‹é¢æ˜¯Rcppç‰ˆï¼š

``` cpp
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
List rleC(NumericVector x) {
  std::vector<int> lengths;
  std::vector<double> values;

  // Initialise first value
  int i = 0;
  double prev = x[0];
  values.push_back(prev);
  lengths.push_back(1);

  NumericVector::iterator it;
  for(it = x.begin() + 1; it != x.end(); ++it) {
    if (prev == *it) {
      lengths[i]++;
    } else {
      values.push_back(*it);
      lengths.push_back(1);

      i++;
      prev = *it;
    }
  }

  return List::create(
    _["lengths"] = lengths,
    _["values"] = values
  );
}
```

[vector](https://en.cppreference.com/w/cpp/container/vector)ä¸­æè¿°äº†vectorçš„æ›´å¤šæ–¹æ³•ã€‚

#### Sets

set åŒ…å«çš„å…ƒç´ ä¸èƒ½é‡å¤ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³æŸ¥æ‰¾é‡å¤æˆ–å”¯ä¸€å…ƒç´ çš„é—®é¢˜ã€‚C++æä¾›äº†æœ‰åºé›†åˆï¼ˆ`std::set`ï¼‰å’Œæ— åºé›†åˆï¼ˆ`std::unordered_set`ï¼‰ä¸¤ç§æ•°æ®ç»“æ„ã€‚æ— åºé›†åˆé€šå¸¸è¿è¡Œå¾ˆå¿«ï¼Œæœ‰æ—¶å¯ä»¥ä½¿ç”¨æ— åºé›†åˆ+æ’åºçš„ä¸¤å¸ƒèµ°æ¥æ›¿ä»£æœ‰åºé›†åˆã€‚åŒvectorä¸€æ ·ï¼Œsetä¹Ÿæ˜¯æ¨¡æ¿åŒ–çš„ï¼Œä½ éœ€è¦åŒ…å«ä¸åŒå…ƒç´ çš„setè¿›è¡Œå£°æ˜ï¼š`set<int>`ã€`set<bool>`ã€`set<double>`ã€`set<String>`ã€‚æ›´å¤šä¿¡æ¯ä½ å¯ä»¥å‚è€ƒ[set](https://en.cppreference.com/w/cpp/container/set)å’Œ[unordered_set](https://en.cppreference.com/w/cpp/container/unordered_set)ã€‚

ä¸‹é¢æ˜¯Rä¸­`duplicated()`å‡½æ•°çš„Rcppå®ç°ï¼Œæ³¨æ„`seen.insert(x[i]).second.insert()`è¿”å›ä¸€ä¸ªpairå€¼ï¼Œå®ƒçš„`.first`å€¼æ˜¯ä¸€ä¸ªæŒ‡å‘å…ƒç´ çš„è¿­ä»£å™¨ï¼Œ`.second`å€¼æ˜¯ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦æ–°æ’å…¥é›†åˆçš„å¸ƒå°”å€¼ï¼š

``` cpp
// [[Rcpp::plugins(cpp11)]]
#include <Rcpp.h>
#include <unordered_set>
using namespace Rcpp;

// [[Rcpp::export]]
LogicalVector duplicatedC(IntegerVector x) {
  std::unordered_set<int> seen;
  int n = x.size();
  LogicalVector out(n);

  for (int i = 0; i < n; ++i) {
    out[i] = !seen.insert(x[i]).second;
  }

  return out;
}
```

#### Map

mapä¸setç±»ä¼¼ï¼Œä½†æ˜¯mapä¸ä»…å¯ä»¥ç”¨æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œè¿˜å…³è”å…¶ä»–æ•°æ®ï¼Œå®ƒç”±é”®å€¼å¯¹ç»„æˆã€‚ååˆ†é€‚åˆRä¸­ç±»ä¼¼`table()`æˆ–`match()`ç­‰å‡½æ•°çš„å®ç°ã€‚mapä¹Ÿæ˜¯æ¨¡æ¿åŒ–çš„ï¼Œä½†æ˜¯ç”±äºå®ƒåŒæ—¶æœ‰é”®å’Œå€¼ï¼Œæ‰€ä»¥éœ€è¦å£°æ˜ä¸¤ä¸ªç±»å‹ï¼Œä¾‹å¦‚ï¼š`map<int, int>`ã€`map<bool, int>`ã€`map<double, int>`ã€`map<String, int>`ã€‚mapåŒæ ·åˆ†æœ‰åºï¼ˆ`std::map`ï¼‰å’Œæ— åºï¼ˆ`std::unordered_map`ï¼‰ä¸¤ç§ã€‚æ›´å¤šä¿¡æ¯ä½ å¯ä»¥å‚è€ƒ[map](https://en.cppreference.com/w/cpp/container/map)å’Œ[unordered_map](https://en.cppreference.com/w/cpp/container/unordered_map)ã€‚ ï¼‰ã€‚

ä¸‹é¢æ˜¯Rä¸­`table()`å‡½æ•°çš„Rcppå®ç°ï¼š

``` cpp
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
std::map<double, int> tableC(NumericVector x) {
  std::map<double, int> counts;

  int n = x.size();
  for (int i = 0; i < n; i++) {
    counts[x[i]]++;
  }

  return counts;
}
```

## Case studies

ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨C++æ›¿æ¢Rä¸­è¿è¡Œç¼“æ…¢å‡½æ•°çš„ä¾‹å­ã€‚

### Gibbs sampler

ç¤ºä¾‹æ¥æºè‡ªDirk Eddelbuettelçš„[blog](http://dirk.eddelbuettel.com/blog/2011/07/14/)ã€‚Rå’ŒC++çš„å‰å¸ƒæ–¯é‡‡æ ·å‡½æ•°å®ç°ç±»ä¼¼ï¼Œä½†æ˜¯è¿è¡Œé€Ÿåº¦ç›¸å·®æå¤§ã€‚Dirkåœ¨åšå®¢ä¸­è¿˜å±•ç¤ºäº†å¦ä¸€ç§ä½¿é€Ÿåº¦æ›´å¿«çš„æ–¹æ³•ï¼šä½¿ç”¨GSLï¼ˆRå¯ä»¥é€šè¿‡RcppGSLåŒ…è½»è®¿é—®ï¼‰ä¸­æ›´å¿«çš„éšæœºæ•°ç”Ÿæˆå™¨å‡½æ•°, å¯ä»¥ä½¿é€Ÿåº¦å†æé«˜ä¸¤åˆ°ä¸‰å€ã€‚

Rç‰ˆæœ¬ï¼š

```{r}
gibbs_r <- function(N, thin) {
  mat <- matrix(nrow = N, ncol = 2)
  x <- y <- 0

  for (i in 1:N) {
    for (j in 1:thin) {
      x <- rgamma(1, 3, y * y + 4)
      y <- rnorm(1, 1 / (x + 1), 1 / sqrt(2 * (x + 1)))
    }
    mat[i, ] <- c(x, y)
  }
  mat
}
```

C++ç‰ˆæœ¬ï¼š

-   å£°æ˜æ‰€æœ‰å˜é‡çš„æ•°æ®ç±»å‹ã€‚
-   ä½¿ç”¨`(`è€Œä¸æ˜¯`[`æ¥è·å–çŸ©é˜µç´¢å¼•ã€‚
-   å°†`rgamma()`å’Œ`rnorm()`å‡½æ•°çš„ç»“æœç”±å‘é‡è½¬æ¢ä¸ºæ ‡é‡ã€‚

```{r, engine = "Rcpp"}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericMatrix gibbs_cpp(int N, int thin) {
  NumericMatrix mat(N, 2);
  double x = 0, y = 0;

  for(int i = 0; i < N; i++) {
    for(int j = 0; j < thin; j++) {
      x = rgamma(1, 3, 1 / (y * y + 4))[0];
      y = rnorm(1, 1 / (x + 1), 1 / sqrt(2 * (x + 1)))[0];
    }
    mat(i, 0) = x;
    mat(i, 1) = y;
  }

  return(mat);
}
```

åŸºå‡†æµ‹è¯•ä¸¤ä¸ªæ–¹æ³•ï¼š

```{r}
bench::mark(
  gibbs_r(100, 10),
  gibbs_cpp(100, 10),
  check = FALSE
)
```

### R vectorisation versus C++ vectorisation

ç¤ºä¾‹æ¥æºå­[â€œRcpp is smoking fast for agent-based models in data framesâ€](https://gweissman.github.io/post/rcpp-is-smoking-fast-for-agent-based-models-in-data-frames/)ã€‚å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ä¸‰ä¸ªè¾“å…¥æ¥é¢„æµ‹ä¸€ä¸ªæ¨¡å‹çš„è¾“å‡ºï¼š

```{r}
vacc1a <- function(age, female, ily) {
  p <- 0.25 + 0.3 * 1 / (1 - exp(0.04 * age)) + 0.1 * ily
  p <- p * if (female) 1.25 else 0.75
  p <- max(0, p)
  p <- min(1, p)
  p
}
```

å½“ä¸‰ä¸ªè¾“å…¥æ˜¯ä¸€ä¸ªå‘é‡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨for-loopæ¥å¤„ç†ï¼š

```{r}
vacc1 <- function(age, female, ily) {
  n <- length(age)
  out <- numeric(n)
  for (i in seq_len(n)) {
    out[i] <- vacc1a(age[i], female[i], ily[i])
  }
  out
}
```

ç»“åˆå‰é¢ç« èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤å®š`vacc1()`è¿è¡Œé€Ÿåº¦ä¼šæ˜¯æ…¢çš„ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³ï¼š

-   ä½¿ç”¨Rä¸­çš„å‘é‡åŒ–å‡½æ•°`ifelse()`ã€`pmin()`å’Œ`pmax()`æ¥ä»£æ›¿for-loopã€‚

    ```{r}
    vacc2 <- function(age, female, ily) {
      p <- 0.25 + 0.3 * 1 / (1 - exp(0.04 * age)) + 0.1 * ily
      p <- p * ifelse(female, 1.25, 0.75)
      p <- pmax(0, p)
      p <- pmin(1, p)
      p
    }
    ```

-   ä½¿ç”¨C++é‡æ„å‡½æ•°`vacc1a()`å’Œ`vacc1()`ã€‚

    ```{r, engine = "Rcpp"}
    #include <Rcpp.h>
    using namespace Rcpp;

    double vacc3a(double age, bool female, bool ily){
      double p = 0.25 + 0.3 * 1 / (1 - exp(0.04 * age)) + 0.1 * ily;
      p = p * (female ? 1.25 : 0.75);
      p = std::max(p, 0.0);
      p = std::min(p, 1.0);
      return p;
    }

    // [[Rcpp::export]]
    NumericVector vacc3(NumericVector age, LogicalVector female,
                        LogicalVector ily) {
      int n = age.size();
      NumericVector out(n);

      for(int i = 0; i < n; ++i) {
        out[i] = vacc3a(age[i], female[i], ily[i]);
      }

      return out;
    }
    ```

ç”Ÿæˆç¤ºä¾‹æ•°æ®å¹¶è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼š

```{r}
n <- 1000
age <- rnorm(n, mean = 50, sd = 10)
female <- sample(c(T, F), n, rep = TRUE)
ily <- sample(c(T, F), n, prob = c(0.8, 0.2), rep = TRUE)

stopifnot(
  all.equal(vacc1(age, female, ily), vacc2(age, female, ily)),
  all.equal(vacc1(age, female, ily), vacc3(age, female, ily))
)

bench::mark(
  vacc1 = vacc1(age, female, ily),
  vacc2 = vacc2(age, female, ily),
  vacc3 = vacc3(age, female, ily)
)
```

## Using Rcpp in a package

`sourceCpp()`å‡½æ•°å¯ä»¥å°†C++è„šæœ¬åµŒå…¥RåŒ…ä¸­ã€‚å°†C++è„šæœ¬ç»‘å®šåˆ°RåŒ…ä¸­æœ‰ä¸‹é¢ä¸‰ç‚¹å¥½å¤„ï¼š

-   ä½¿ç”¨è€…å¯ä»¥è„±ç¦»C++å¼€å‘å·¥å…·ï¼Œç›´æ¥ä½¿ç”¨C++ç¼–å†™çš„å‡½æ•°ã€‚

-   RåŒ…æ„å»ºç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¤šä¸ªæºæ–‡ä»¶åŠå…¶ä¾èµ–å…³ç³»ã€‚

-   è½¯ä»¶åŒ…ä¸ºæµ‹è¯•ã€æ–‡æ¡£å’Œä¸€è‡´æ€§æä¾›äº†é¢å¤–çš„åŸºç¡€å·¥å…·ã€‚

åœ¨RåŒ…ä¸­ä½¿ç”¨`Rcpp`å‡½æ•°ï¼Œä½ éœ€è¦ï¼š

-   åœ¨`scr/`ç›®å½•ä¸‹æ”¾ç½®C++æºæ–‡ä»¶ã€‚

-   åœ¨`DESCRIPTION`æ–‡ä»¶ä¸­æ·»åŠ ï¼š

    ```
    LinkingTo: Rcpp
    Imports: Rcpp
    ```

-   åœ¨`NAMESPACE`æ–‡ä»¶ä¸­æ·»åŠ ï¼š

    ```
    useDynLib(mypackage)
    importFrom(Rcpp, sourceCpp)
    ```

    æˆ‘ä»¬éœ€è¦ä»Rcppå¯¼å…¥ä¸€äº›ä¸œè¥¿ï¼ˆä»»ä½•ä¸œè¥¿ï¼‰, ä»¥ä¾¿å†…éƒ¨Rcppä»£ç èƒ½å¤Ÿæ­£ç¡®åŠ è½½ã€‚è¿™æ˜¯Rä¸­çš„ä¸€ä¸ªbugï¼ˆä¸ç¡®å®šç°åœ¨æ˜¯å¦ä¿®å¤ï¼‰ã€‚

å¯ä»¥ä½¿ç”¨`usethis::use_rcpp()`æ¥å¿«æ·åœ°æ·»åŠ è¿™äº›å†…å®¹ã€‚

åœ¨æ„å»ºRåŒ…æ—¶ï¼Œä½ éœ€è¦å…ˆè¿è¡Œ`Rcpp::compileAttributes()`ã€‚è¯¥å‡½æ•°æ‰«æC++è„šæœ¬ä¸­æœ‰`Rcpp::export`å±æ€§çš„å‡½æ•°ï¼Œå¹¶ç”Ÿæˆä½¿å‡½æ•°åœ¨Rä¸­å¯ç”¨æ‰€éœ€çš„ä»£ç ã€‚æ¯å½“æ·»åŠ ã€åˆ é™¤æˆ–æ›´æ”¹å‡½æ•°ç­¾åæ—¶ï¼Œéƒ½ä¼šé‡æ–°è¿è¡Œ`compileAttributes()`ã€‚è¿™æ˜¯ç”±devtoolsåŒ…å’ŒRstudioè‡ªåŠ¨å®Œæˆçš„ã€‚

æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒ`vignette("Rcpp-package")`ã€‚

## Learning more

æœ¬ç« åªæ¶‰åŠäº†Rcppçš„ä¸€å°éƒ¨åˆ†ï¼Œæä¾›äº†ä½¿ç”¨C++é‡å†™æ€§èƒ½ä¸ä½³çš„Rä»£ç çš„åŸºæœ¬å·¥å…·ã€‚å¦‚å‰æ‰€è¿°ï¼ŒRcppè¿˜æœ‰è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œä½¿å¾—å°†Rä¸ç°æœ‰C++ä»£ç æ¥å£å˜å¾—å®¹æ˜“ï¼ŒåŒ…æ‹¬ï¼š

-   å±æ€§çš„å…¶ä»–åŠŸèƒ½åŒ…æ‹¬æŒ‡å®šé»˜è®¤å‚æ•°ã€é“¾æ¥å¤–éƒ¨C++ä¾èµ–é¡¹ä»¥åŠä»åŒ…å¯¼å‡ºC++æ¥å£ã€‚è¿™äº›åŠŸèƒ½åŠæ›´å¤šå†…å®¹å°†åœ¨`vinette("Rcpp-attributes")`ä¸­ä»‹ç»ã€‚

-   è‡ªåŠ¨åˆ›å»ºC++æ•°æ®ç»“æ„å’ŒRæ•°æ®ç»“æ„ä¹‹é—´çš„åŒ…è£…ï¼ŒåŒ…æ‹¬å°†C++ç±»æ˜ å°„åˆ°å¼•ç”¨ç±»ã€‚å¯¹è¿™ä¸ªä¸»é¢˜çš„ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»æ˜¯`vienette("Rcpp-modules")`ã€‚

-   Rcppå¿«é€Ÿå‚è€ƒæŒ‡å—`vignette("Rcpp-quickref")`åŒ…å«äº†Rcppç±»å’Œå¸¸è§ç¼–ç¨‹ä¹ è¯­çš„æœ‰ç”¨æ€»ç»“ã€‚

å¯ä»¥å…³æ³¨ä¸€ä¸‹[Rcpp homepage](https://www.rcpp.org/)æˆ–ç™»å½•[Rcpp mailing list](http://lists.r-forge.r-project.org/cgi-bin/mailman/listinfo/rcpp-devel)ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¯¹å­¦ä¹ C++å¾ˆæœ‰å¸®åŠ©çš„èµ„æºï¼š

-   Effective C++ã€Effective STLã€‚

-   [C++ Annotations](http://www.icce.rug.nl/documents/cplusplus/cplusplus.html)

-   [Algorithm Libraries](http://www.cs.helsinki.fi/u/tpkarkka/alglib/k06/)

ç¼–å†™é«˜æ€§èƒ½ä»£ç ä¹Ÿå¯èƒ½éœ€è¦ä½ é‡æ–°æ€è€ƒä½ çš„åŸºæœ¬æ–¹æ³•ï¼Œå¯¹åŸºæœ¬æ•°æ®ç»“æ„å’Œç®—æ³•çš„æ‰å®ç†è§£éå¸¸æœ‰å¸®åŠ©ã€‚ä½ å¯ä»¥å‚è€ƒï¼š

-   Algorithm Design Manual

-   MITçš„[Introduction to Algorithms](http://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-046j-introduction-to-algorithms-sma-5503-fall-2005/)

-   Algorithms 4th Editionï¼Œ[textbook](https://algs4.cs.princeton.edu/home/)ã€‚
