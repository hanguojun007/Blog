---
title: "21 Translating R code"
date: "2025-08-20"
date-modified: "2025-08-20"

format: "html"
fig-width: 6
fig-asp: 0.618
out-width: 70%
fig-align: center

knitr:
  opts_chunk:
    collapse: true
    comment: "#>"
    R.options:
      dplyr.print_min: 6
      dplyr.print_max: 6
      pillar.max_footer_lines: 2
      pillar.min_chars: 15
      stringr.view_n: 6
      cli.num_colors: 0
      cli.hyperlink: FALSE
      pillar.bold: TRUE
      width: 77

execute:
  warning: true
  error: true
---

## Introduction

first-class环境，词法作用域，元编程组成了一套实现将R代码转换为其他语言的工具箱。例如，`dbplyr`为`dplyr`处理数据库提供了支持，允许用R语言表达数据操作并自动将其翻译成SQL，可以使用`translate_sql()`一览其关键思想：

```{r}
library(dbplyr)
con <- simulate_postgres()

translate_sql(x^2, con = con)
translate_sql(x < 5 & !is.na(x), con = con)
translate_sql(!first %in% c("John", "Roger", "Robert"), con = con)
translate_sql(select == 7, con = con)
```

由于SQL语言有许多特性，将R语言翻译成SQL语言的机制非常复杂，因此本章我们介绍两种简单但有用的领域特定语言(DSL): 一种用于生成HTML, 另一种用于在LaTeX中生成数学方程。

### Outline

-   21.2节：介绍创建HTML。

-   21.2节：介绍创建LaTeX。

### Prerequisites

学习本章，你需要了解：环境、表达式、整洁评估、泛函编程、元编程、S3面向对象等。

```{r}
library(rlang)
library(purrr)
```

## HTML

HTML文件是网站的底层核心，是一种特殊的标记语言（SGML，Standard Generalised Markup Language），它和XML相似但不等同。

```html
<body>
  <h1 id='first'>A heading</h1>
  <p>Some text &amp; <b>some bold text.</b></p>
  <img src='myimg.png' width='100' height='100' />
</body>
```

HTML文件中的关键组件是标签（tag），形如`<tag></tag>`或`<tag/>`。标签可以嵌套在其他标签中，并与文本交织在一起。HTML标签有超过100个，但在本章中，我们只关注其中的少数几个：

-   `<body>`：文档的主体，包含文档所有内容的顶级标签。
-   `<h1>`：文档的标题级别。
-   `<p>`：段落。
-   `<b>`：粗体。
-   `<img>`：图片。

标签具有带名字的属性，形如`<tag name1='value1' name2='value2'/></tag>`。其中有两个重要的属性——`id`和`class`，它们会与CSS联合使用来控制页面的外观。

`<img>`标签不包裹任何内容，它只能被写作`<img />`而不能写成`<img></img>`，类似`<img>`的标签被称为空标签（Void tags）。因为它们不能包裹内容，所以它们的属性非常重要，`<img>`有三个常被使用的属性：`scr`控制图片路径，`width`和`height`控制图片大小。

因为`<`和`>`是HTML中的特殊字符，想要在文本中书写它们，必须用转义符`&lt;`和`&gt;`来代替。同样，`&`也必须用转义符`&amp;`来代替。

### Goal

我们的目标是使用R生成上面的模板html文档。类似：

```r
with_html(
  body(
    h1("A heading", id = "first"),
    p("Some text &", b("some bold text.")),
    img(src = "myimg.png", width = 100, height = 100)
  )
)
```

它有三个特点：

-   函数名与标签名相同。
-   未命名参数成为标签的内容，而命名参数成为其属性。
-   & 和其他特殊字符会自动转义。

### Escaping